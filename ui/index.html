<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>HEIMDALL Dashboard</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="heimdall-logo.svg">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: auto;
            background: #000000;
            color: #FFCC00;
            font-family: 'Orbitron', 'Antonio', 'Oswald', "Myriad Pro Cond", "Roboto Condensed", sans-serif;
            font-size: 17px;
            line-height: 1.42857;
            overflow-x: hidden;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
        }
        
        @media (max-width: 768px) {
            html {
                overflow-y: auto !important;
                overflow-x: hidden;
                -webkit-overflow-scrolling: touch;
            }

            body {
                overflow-y: auto !important;
                overflow-x: hidden;
                -webkit-overflow-scrolling: touch;
                position: relative;
            }
        }

        .header {
            display: none;
        }

        .container {
            display: flex;
            gap: 0;
            min-height: 100vh;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                min-height: auto;
            }
        }

        /* SIDEBAR - LCARS Style */
        .sidebar {
            width: 240px;
            background: #000000;
            border-right: 4px solid #FF9900;
            border-radius: 0 30px 30px 0; /* Rounded panel edge */
            padding: 0;
            position: relative;
            flex-shrink: 0;
            margin-right: 15px;
            box-shadow: 4px 0 15px rgba(255, 153, 0, 0.1);
            overflow-y: auto; /* Allow scrolling within the sidebar itself */
        }

        .sidebar::before { display: none; }

        .sidebar-logo {
            padding: 4px 4px;
            font-size: 20px;
            font-weight: 900;
            color: #FFCC00;
            background: linear-gradient(135deg, #FF9900, #FF6600);
            margin-bottom: 0;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-family: 'Orbitron', sans-serif;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            box-shadow: 0 6px 16px rgba(255, 153, 0, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.3);
            min-height: auto;
        }

        .sidebar-logo::after {
            content: '';
            position: absolute;
            bottom: -20px;
            left: 0;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 20px 0 0 240px;
            border-color: #FF9900 transparent transparent transparent;
        }

        .sidebar-section {
            margin-bottom: 0;
            padding: 0;
            background: #000000;
        }

        .sidebar-title {
            font-size: 14px;
            color: #FF9900;
            text-transform: uppercase;
            letter-spacing: 3px;
            font-weight: 700;
            margin: 20px 0 10px 20px;
            padding: 0;
            font-family: 'Orbitron', sans-serif;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 20px;
            font-size: 16px;
            color: #FFCC00;
            margin-bottom: 2px;
            background: #000000;
            font-family: 'Orbitron', sans-serif;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
            box-shadow: 0 0 8px currentColor;
        }

        .status-dot.green { background: #00FF00; color: #00FF00; }
        .status-dot.red { background: #FF0000; color: #FF0000; }
        .status-dot.orange { background: #FF9900; color: #FF9900; }

        .nav-btn {
            width: calc(100% - 20px);
            padding: 12px 20px;
            margin: 5px 10px;
            background: transparent;
            color: #FFCC00;
            border: 2px solid transparent;
            text-align: left;
            font-size: 16px;
            font-weight: 500;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 30px; /* Pill shape */
            font-family: 'Orbitron', sans-serif;
            letter-spacing: 1px;
            position: relative;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            min-height: 44px;
        }

        .nav-btn::before { display: none; }

        .nav-btn:hover {
            background: rgba(255, 204, 0, 0.1);
            color: #FFCC00;
            border-color: #FF9900;
        }

        .nav-btn.active {
            background: #FF9900;
            color: #000000;
            font-weight: 700;
            border-color: #FF9900;
            box-shadow: 0 0 15px rgba(255, 153, 0, 0.4);
        }

        .nav-btn.alerts {
            color: #FF3366;
        }

        .nav-btn.alerts:hover {
            background: rgba(255, 51, 102, 0.1);
            border-color: #FF3366;
        }

        .nav-btn.alerts.active {
            background: #FF3366;
            color: #000000;
            border-color: #FF3366;
            box-shadow: 0 0 15px rgba(255, 51, 102, 0.4);
        }

        /* Remove old color variations logic that relied on nth-child borders */
        .nav-btn:nth-child(1), .nav-btn:nth-child(2), .nav-btn:nth-child(3), 
        .nav-btn:nth-child(4), .nav-btn:nth-child(5) {
            border-left-color: transparent;
        }

        /* MAIN CONTENT AREA - LCARS Style */
        .content {
            flex: 1;
            padding: 20px;
            background: #000000;
            min-width: 0; /* Prevent flex overflow */
            position: relative;
            z-index: 1;
        }

        /* KPI BOXES - LCARS Style */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-box {
            background: #111;
            border: 2px solid #333;
            border-left-width: 8px;
            border-radius: 15px; /* Rounded corners */
            padding: 20px;
            padding-top: 20px;
            padding-right: 20px;
            text-align: left;
            min-height: 160px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        /* Remove old LCARS pseudo-elements */
        .metric-box::before, .metric-box::after {
            display: none;
        }

        .metric-box.blue { border-left-color: #0099FF; }
        .metric-box.red { border-left-color: #FF3366; }
        .metric-box.orange { border-left-color: #FF9900; }
        .metric-box.green { border-left-color: #00FF99; }
        .metric-box.cyan { border-left-color: #00CCFF; }

        .metric-icon {
            font-size: 40px;
            margin-bottom: 10px;
            opacity: 0.8;
            position: absolute;
            top: 20px;
            right: 20px;
        }

        .metric-box.blue .metric-icon { color: #0099FF; }
        .metric-box.red .metric-icon { color: #FF3366; }
        .metric-box.orange .metric-icon { color: #FF9900; }
        .metric-box.green .metric-icon { color: #00FF99; }
        .metric-box.cyan .metric-icon { color: #00CCFF; }

        .metric-value {
            font-size: 42px;
            font-weight: 900;
            line-height: 1.2;
            margin: 10px 0 5px 0;
            color: #FFCC00;
            font-family: 'Orbitron', sans-serif;
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.5);
        }

        .metric-label {
            font-size: 16px;
            color: #FFCC00;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 600;
            margin: 0 0 5px 0;
            font-family: 'Orbitron', sans-serif;
        }

        .metric-sub {
            font-size: 12px;
            color: #FF9900;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-family: 'Orbitron', sans-serif;
        }
        
        .metric-sub a {
            color: #FFCC00;
            text-decoration: none;
        }
        
        .metric-sub a:hover {
            text-decoration: underline;
            color: #FF9900;
        }

        /* CHART AND TABLE CONTAINERS - Pi-hole Style */
        .content-sections {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .section-box {
            background: #111;
            border: 2px solid #333;
            border-left-width: 8px;
            border-radius: 15px; /* Rounded corners */
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .section-box::before { display: none; }

        /* Color variation for sections */
        .section-box:nth-child(1) { border-left-color: #0099FF; }
        .section-box:nth-child(2) { border-left-color: #FF3366; }
        .section-box:nth-child(3) { border-left-color: #00FF99; }
        .section-box:nth-child(4) { border-left-color: #00CCFF; }
        .section-box:nth-child(5) { border-left-color: #FF9900; }

        .section-title {
            color: #FFCC00;
            font-size: 24px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 3px;
            margin: 0 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #333;
            font-family: 'Orbitron', sans-serif;
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.3);
        }

        /* Color variation for section titles */
        .section-box:nth-child(1) .section-title { color: #0099FF; border-bottom-color: #0099FF; }
        .section-box:nth-child(2) .section-title { color: #FF3366; border-bottom-color: #FF3366; }
        .section-box:nth-child(3) .section-title { color: #00FF99; border-bottom-color: #00FF99; }
        .section-box:nth-child(4) .section-title { color: #00CCFF; border-bottom-color: #00CCFF; }
        .section-box:nth-child(5) .section-title { color: #FF9900; border-bottom-color: #FF9900; }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .table-box {
            background: #111;
            border: 2px solid #333;
            border-left-width: 8px;
            border-radius: 15px; /* Rounded corners */
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            overflow-x: auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .table-box::before { display: none; }

        /* Color variation for tables */
        .table-box:nth-child(1) { border-left-color: #00FF99; }
        .table-box:nth-child(2) { border-left-color: #FF3366; }
        .table-box:nth-child(3) { border-left-color: #00CCFF; }
        .table-box:nth-child(4) { border-left-color: #0099FF; }
        .table-box:nth-child(5) { border-left-color: #FF9900; }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 16px;
            color: #FFCC00;
            margin-bottom: 20px;
            font-family: 'Orbitron', sans-serif;
            white-space: normal;
            word-wrap: break-word;
        }

        .data-table thead {
            border-bottom: 3px solid #FF9900;
        }

        .data-table th {
            padding: 12px 8px;
            text-align: left;
            color: #FFCC00;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 14px;
            letter-spacing: 2px;
            background: transparent;
            line-height: 1.42857;
            vertical-align: top;
            border-top: 2px solid #FF9900;
            font-family: 'Orbitron', sans-serif;
        }

        /* Color variation for table headers based on parent table-box */
        .table-box:nth-child(1) .data-table thead {
            border-bottom-color: #00FF99;
        }
        .table-box:nth-child(1) .data-table th {
            border-top-color: #00FF99;
            color: #00FF99;
        }

        .table-box:nth-child(2) .data-table thead {
            border-bottom-color: #FF3366;
        }
        .table-box:nth-child(2) .data-table th {
            border-top-color: #FF3366;
            color: #FF3366;
        }

        .table-box:nth-child(3) .data-table thead {
            border-bottom-color: #00CCFF;
        }
        .table-box:nth-child(3) .data-table th {
            border-top-color: #00CCFF;
            color: #00CCFF;
        }

        .table-box:nth-child(4) .data-table thead {
            border-bottom-color: #0099FF;
        }
        .table-box:nth-child(4) .data-table th {
            border-top-color: #0099FF;
            color: #0099FF;
        }

        .table-box:nth-child(5) .data-table thead {
            border-bottom-color: #FF9900;
        }
        .table-box:nth-child(5) .data-table th {
            border-top-color: #FF9900;
            color: #FF9900;
        }

        .data-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #333333;
            color: #FFCC00;
            line-height: 1.42857;
            vertical-align: top;
            border-top: 1px solid #1a1a1a;
        }

        .data-table tr:hover {
            background: #1a1a1a;
        }

        .page {
            display: none;
            width: 100%;
            padding: 20px 0;
        }

        .page.active {
            display: block;
            width: 100%;
            padding: 20px 0;
        }

        /* RESPONSIVE DESIGN - Mobile & Tablet */
        
        /* Mobile Menu Toggle Button */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 10001;
            background: #FF9900;
            color: #000000;
            border: 2px solid #FFCC00;
            padding: 0;
            font-size: 24px;
            font-weight: 900;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(255, 153, 0, 0.4);
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            width: 50px;
            height: 50px;
            display: none;
            align-items: center;
            justify-content: center;
            line-height: 1;
            transition: all 0.2s;
        }

        .mobile-menu-toggle:active {
            background: #FFCC00;
            border-color: #FF9900;
            transform: scale(0.95);
        }
        
        .mobile-menu-toggle:hover {
            box-shadow: 0 6px 16px rgba(255, 153, 0, 0.6);
        }

        /* Mobile sidebar backdrop */
        .sidebar-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sidebar-backdrop.active {
            display: block;
            opacity: 1;
        }

        /* Export and Action Buttons */
        .export-btn {
            padding: 10px 16px;
            border: 2px solid #FFCC00;
            background: #FF9900;
            color: #000000;
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            font-size: 14px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 2px;
            letter-spacing: 1px;
            min-height: 44px;
            display: flex;
            align-items: center;
            gap: 6px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 204, 0, 0.4);
            border-color: #FFFFFF;
        }

        .export-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(255, 204, 0, 0.2);
        }

        /* ==================== SEARCH & FILTER PANEL CSS ==================== */

        .search-filter-panel {
            background: linear-gradient(135deg, #000000, #1a1a1a);
            border: 2px solid #FF8800;
            border-left: 8px solid #FF8800;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(255, 136, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .search-filter-title {
            font-size: 16px;
            font-weight: 900;
            color: #FF8800;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 15px;
            font-family: 'Orbitron', sans-serif;
        }

        .search-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: flex-end;
        }

        .search-input {
            flex: 1;
            padding: 10px 12px;
            background: #1a1a1a;
            color: #FFCC00;
            border: 2px solid #FF8800;
            font-family: 'Orbitron', sans-serif;
            font-size: 14px;
            border-radius: 2px;
            outline: none;
            transition: all 0.2s;
        }

        .search-input:focus {
            border-color: #FFAA00;
            box-shadow: 0 0 8px rgba(255, 136, 0, 0.6);
            background: #222222;
        }

        .search-input::placeholder {
            color: #666666;
        }

        .search-btn {
            padding: 10px 20px;
            background: #FF8800;
            color: #000000;
            border: none;
            font-weight: 900;
            cursor: pointer;
            border-radius: 2px;
            font-family: 'Orbitron', sans-serif;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
            height: 42px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .search-btn:hover {
            background: #FFAA00;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 136, 0, 0.6);
        }

        .search-tips-btn {
            padding: 10px 15px;
            background: transparent;
            color: #00CCFF;
            border: 2px solid #00CCFF;
            font-weight: 700;
            cursor: pointer;
            border-radius: 2px;
            font-family: 'Orbitron', sans-serif;
            font-size: 12px;
            height: 42px;
            transition: all 0.2s;
        }

        .search-tips-btn:hover {
            background: #00CCFF;
            color: #000000;
            box-shadow: 0 0 12px rgba(0, 204, 255, 0.6);
        }

        .applied-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            min-height: 24px;
            align-items: center;
        }

        .filter-chip {
            background: rgba(255, 136, 0, 0.2);
            border: 1px solid #FF8800;
            color: #FFCC00;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-family: 'Orbitron', sans-serif;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .filter-chip-remove {
            cursor: pointer;
            font-weight: bold;
            color: #FF3366;
            hover: color #FF5588;
            transition: color 0.2s;
        }

        .filter-chip-remove:hover {
            color: #FF5588;
        }

        .quick-filters-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }

        .quick-filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .quick-filter-label {
            font-size: 11px;
            color: #00CCFF;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 0.5px;
            font-family: 'Orbitron', sans-serif;
        }

        .quick-filter-select {
            padding: 8px;
            background: #1a1a1a;
            color: #FFCC00;
            border: 2px solid #0099FF;
            font-family: 'Orbitron', sans-serif;
            font-size: 13px;
            border-radius: 2px;
            cursor: pointer;
            transition: all 0.2s;
            outline: none;
        }

        .quick-filter-select:focus {
            border-color: #00CCFF;
            box-shadow: 0 0 8px rgba(0, 204, 255, 0.6);
            background: #222222;
        }

        .quick-filter-select option {
            background: #1a1a1a;
            color: #FFCC00;
        }

        .search-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .reset-filters-btn {
            padding: 8px 16px;
            background: #FF3366;
            color: #FFFFFF;
            border: none;
            font-weight: 700;
            cursor: pointer;
            border-radius: 2px;
            font-family: 'Orbitron', sans-serif;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
        }

        .reset-filters-btn:hover {
            background: #FF5588;
            box-shadow: 0 4px 12px rgba(255, 51, 102, 0.6);
            transform: translateY(-2px);
        }

        .search-tips-popover {
            display: none;
            background: #0a0a0a;
            border: 2px solid #00CCFF;
            border-radius: 4px;
            padding: 15px;
            margin-top: 10px;
            font-size: 12px;
            color: #FFCC00;
            font-family: 'Orbitron', sans-serif;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
        }

        .search-tips-popover.show {
            display: block;
        }

        .search-tips-popover h4 {
            color: #00CCFF;
            font-size: 13px;
            margin-bottom: 8px;
            margin-top: 10px;
        }

        .search-tips-popover h4:first-child {
            margin-top: 0;
        }

        .search-tips-popover code {
            background: #1a1a1a;
            padding: 2px 6px;
            border-radius: 2px;
            color: #FF8800;
            font-family: monospace;
        }

        .search-tips-popover ul {
            margin-left: 20px;
            margin-bottom: 0;
        }

        .search-tips-popover li {
            margin-bottom: 6px;
        }

        /* Pagination Controls */
        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 136, 0, 0.05);
            border: 1px solid #FF8800;
            border-radius: 4px;
            flex-wrap: wrap;
        }

        .pagination-btn {
            padding: 8px 12px;
            background: #FF8800;
            color: #000000;
            border: none;
            font-weight: 700;
            cursor: pointer;
            border-radius: 2px;
            font-family: 'Orbitron', sans-serif;
            font-size: 12px;
            transition: all 0.2s;
            min-width: 44px;
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #FFAA00;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 136, 0, 0.6);
        }

        .pagination-btn:disabled {
            background: #666666;
            color: #999999;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .pagination-info {
            color: #FFCC00;
            font-family: 'Orbitron', sans-serif;
            font-size: 12px;
            font-weight: 700;
            min-width: 200px;
            text-align: center;
        }

        .pagination-input {
            padding: 6px 8px;
            background: #1a1a1a;
            color: #FFCC00;
            border: 2px solid #FF8800;
            font-family: 'Orbitron', sans-serif;
            font-size: 12px;
            width: 70px;
            text-align: center;
            border-radius: 2px;
        }

        /* Tablet and smaller desktop */
        @media (max-width: 1600px) {
            .metrics-grid { grid-template-columns: repeat(2, 1fr); }
            .content-sections { grid-template-columns: 1fr; }
        }

        /* Laptop/Tablet adjustments */
        @media (max-width: 1366px) {
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            .content-sections {
                grid-template-columns: 1fr;
            }
        }

        /* Tablet */
        @media (max-width: 1024px) {
            .sidebar {
                width: 200px;
            }
            
            .sidebar-logo {
                font-size: 18px;
                padding: 12px 15px;
                gap: 8px;
            }

            .sidebar-logo img {
                width: 32px !important;
                height: 32px !important;
            }
            
            .sidebar-logo::after {
                border-width: 20px 0 0 200px;
            }
            
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .metric-value {
                font-size: 32px;
            }
            
            .section-title {
                font-size: 28px;
            }
        }

        /* Intermediate responsiveness */
        @media (max-width: 1200px) {
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            .metric-value {
                font-size: 28px;
            }
            .sidebar {
                width: 200px;
            }
            .sidebar-logo img {
                width: 160px !important;
                height: 160px !important;
            }
        }

        @media (max-width: 900px) {
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            .content-sections {
                grid-template-columns: 1fr;
            }
        }

        /* Mobile devices */
        @media (max-width: 768px) {
            .mobile-menu-toggle {
                display: flex;
            }

            .container {
                flex-direction: column;
            }

            .sidebar {
                position: fixed !important;
                top: 0;
                left: 0;
                height: 100vh;
                z-index: 10000;
                width: 240px;
                background: #000000;
                box-shadow: 2px 0 10px rgba(0,0,0,0.5);
                
                /* Animation & Visibility */
                transition: transform 0.3s ease, visibility 0s linear 0.3s;
                transform: translateX(-100%);
                visibility: hidden;
                
                /* Reset Desktop Styles */
                margin: 0;
                border-radius: 0;
                border-right: 4px solid #FF9900;
            }

            .sidebar.open {
                transform: translateX(0);
                visibility: visible;
                transition: transform 0.3s ease, visibility 0s linear 0s;
            }
            
            .content {
                width: 100%;
                padding: 80px 15px 20px 15px; /* Add top padding for header/toggle */
                min-width: 0;
                position: relative;
                z-index: 1;
            }
        }

        /* Small mobile devices */
        @media (max-width: 480px) {
            .content {
                padding: 80px 10px 15px 10px;
            }
            
            .mobile-menu-toggle {
                top: 12px;
                right: 12px;
                width: 45px;
                height: 45px;
                font-size: 20px;
                padding: 8px 12px;
            }

            .metric-value {
                font-size: 28px;
            }

            .section-title {
                font-size: 20px;
                letter-spacing: 1px;
            }

            .chart-container {
                height: 200px;
            }

            .sidebar-logo {
                font-size: 16px;
                padding: 10px 12px;
                gap: 6px;
            }

            .sidebar-logo img {
                width: 28px !important;
                height: 28px !important;
            }

            .nav-btn {
                padding: 12px 15px;
                font-size: 14px;
            }

            .data-table {
                font-size: 12px;
            }
        }

        /* Landscape mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .chart-container {
                height: 200px;
            }

            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        ::-webkit-scrollbar {
            width: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #000000;
        }
        ::-webkit-scrollbar-thumb {
            background: #333333;
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #444444;
        }
    </style>
</head>
<body>
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Toggle Menu">‚ò∞</button>
    
    <!-- Mobile Sidebar Backdrop -->
    <div class="sidebar-backdrop" id="sidebarBackdrop"></div>
    
    <div class="container">
        <!-- SIDEBAR -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-logo">
                <img src="heimdall-logo.svg" alt="Heimdall" style="width: 220px; height: 220px; margin-right: 0; vertical-align: middle; display: block; filter: drop-shadow(0 0 24px rgba(255, 136, 0, 0.9)); margin: 0 auto 3px auto;">
                <img src="heimdall-text.svg" alt="HEIMDALL" style="width: 230px; height: auto; margin: 0 auto; display: block; filter: drop-shadow(0 0 12px rgba(255, 136, 0, 0.7));">
            </div>
            <div style="padding: 15px 20px; text-align: center; margin-bottom: 0; font-family: 'Orbitron', sans-serif; line-height: 1.6; background: linear-gradient(135deg, rgba(255, 153, 0, 0.1), rgba(0, 153, 255, 0.1)); border-bottom: 2px solid #FF9900;">
                <div id="stardate" style="font-weight: 700; font-size: 13px; color: #FFCC00; letter-spacing: 1px;">Stardate 78342.5</div>
                <div id="current-time" style="font-size: 12px; color: #0099FF; font-weight: 600; letter-spacing: 0.5px; margin-top: 5px;">--:--:-- UTC</div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">STATUS</div>
                <div class="status-indicator">
                    <span class="status-dot green"></span>
                    <span id="stat-online">0</span> Online
                </div>
                <div class="status-indicator">
                    <span class="status-dot red"></span>
                    <span id="stat-offline">0</span> Offline
                </div>
                <div class="status-indicator">
                    <span class="status-dot orange"></span>
                    <span id="stat-alerts">0</span> Alerts
                </div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">DASHBOARD</div>
                <button class="nav-btn active" data-page="dashboard">DASHBOARD</button>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">NAVIGATION</div>
                <button class="nav-btn" data-page="events">Event Log</button>
                <button class="nav-btn" data-page="hosts">Systems</button>
                <button class="nav-btn" data-page="threats">Threats</button>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">TOOLS</div>
                <button class="nav-btn alerts" data-page="alerts">ALERTS</button>
                <button class="nav-btn" data-page="settings">SETTINGS</button>
                <button class="nav-btn" onclick="openExportDialog()">EXPORT LOGS</button>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="content">
            <!-- DASHBOARD PAGE -->
            <div id="page-dashboard" class="page active">
                <!-- TOP METRICS -->
                <div class="metrics-grid">
                    <div class="metric-box blue">
                        <div class="metric-icon">üåê</div>
                        <div>
                            <div class="metric-value" id="m-total">0</div>
                            <div class="metric-label">Total Events</div>
                            <div class="metric-sub">24h events</div>
                        </div>
                    </div>
                    <div class="metric-box red">
                        <div class="metric-icon">üö®</div>
                        <div>
                            <div class="metric-value" id="m-blocked">0</div>
                            <div class="metric-label">Threats Detected</div>
                            <div class="metric-sub">by os detection</div>
                        </div>
                    </div>
                    <div class="metric-box orange">
                        <div class="metric-icon">üì°</div>
                        <div>
                            <div class="metric-value" id="m-sources">0</div>
                            <div class="metric-label">Event Sources</div>
                            <div class="metric-sub">unique hosts</div>
                        </div>
                    </div>
                    <div class="metric-box green">
                        <div class="metric-icon">üñ•Ô∏è</div>
                        <div style="display: flex; flex-direction: column; gap: 10px; width: calc(100% - 20px); max-width: 280px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; gap: 15px;">
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-size: 12px; color: #00FF99; margin-bottom: 4px; font-weight: 600;">Active</div>
                                    <div class="metric-value" id="m-active" style="font-size: 32px; margin: 0; color: #00FF99;">0</div>
                                </div>
                                <div style="width: 1px; height: 40px; background: rgba(0, 255, 153, 0.2); flex-shrink: 0;"></div>
                                <div style="flex: 1; text-align: right; min-width: 0;">
                                    <div style="font-size: 12px; color: #FF6666; margin-bottom: 4px; font-weight: 600;">Inactive</div>
                                    <div class="metric-value" id="m-inactive" style="font-size: 32px; margin: 0; color: #FF6666;">0</div>
                                </div>
                            </div>
                            <div style="border-top: 1px solid rgba(0, 204, 255, 0.2); padding-top: 8px;">
                                <div class="metric-label" style="margin: 0;">Monitored Hosts</div>
                                <div class="metric-sub">active & inactive</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CHARTS ROW -->
                <div class="content-sections">
                    <div class="section-box full-width">
                        <div class="section-title">EVENT TIMELINE - 24 HOURS</div>
                        <div class="chart-container">
                            <canvas id="mainChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="content-sections">
                    <div class="section-box">
                        <div class="section-title">EVENT TYPES DISTRIBUTION</div>
                        <div class="chart-container">
                            <canvas id="typesChart"></canvas>
                        </div>
                    </div>

                    <div class="section-box">
                        <div class="section-title">SEVERITY DISTRIBUTION</div>
                        <div class="chart-container">
                            <canvas id="severityChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- BOTTOM TABLES -->
                <div class="content-sections">
                    <div class="table-box">
                        <div class="section-title">TOP EVENT TYPES</div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Count</th>
                                    <th>%</th>
                                </tr>
                            </thead>
                            <tbody id="table-top-types">
                                <tr><td colspan="3" style="text-align: center; padding: 10px; color: #FFCC00;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="table-box">
                        <div class="section-title">TOP AFFECTED HOSTS</div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Hostname</th>
                                    <th>Events</th>
                                    <th>Severity</th>
                                </tr>
                            </thead>
                            <tbody id="table-top-hosts">
                                <tr><td colspan="3" style="text-align: center; padding: 10px; color: #FFCC00;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- RECENT EVENTS TABLE -->
                <div class="table-box full-width" style="margin-top: 20px;">
                    <div class="section-title">RECENT SECURITY EVENTS</div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Type</th>
                                <th>Host</th>
                                <th>User</th>
                                <th>Severity</th>
                                <th>Message</th>
                            </tr>
                        </thead>
                            <tbody id="table-recent-events">
                            <tr><td colspan="6" style="text-align: center; padding: 10px; color: #FFCC00;">Loading events...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- EVENTS PAGE -->
            <div id="page-events" class="page">
                <!-- Search & Filter Panel -->
                <div class="search-filter-panel" id="search-filter-panel">
                    <div class="search-filter-title">Search & Filter</div>

                    <!-- Search Input -->
                    <div class="search-input-container">
                        <input type="text" id="search-query" class="search-input" placeholder="host:ubuntu severity:5 OR user:root ... (TIPS ‚ñº)" value="" oninput="onSearchInputChange()">
                        <button class="search-btn" onclick="onSearchButtonClick()">üîç SEARCH</button>
                        <button class="search-tips-btn" onclick="toggleSearchTips()">? TIPS</button>
                    </div>

                    <!-- Search Tips Popover -->
                    <div class="search-tips-popover" id="search-tips-popover">
                        <h4>Syntax Examples:</h4>
                        <ul>
                            <li><code>host:ubuntu</code> - Filter by hostname</li>
                            <li><code>user:root</code> - Filter by username</li>
                            <li><code>severity:5</code> - Filter by severity level</li>
                            <li><code>type:LOGIN_FAIL</code> - Filter by event type</li>
                            <li><code>ip:192.168.1.1</code> - Filter by source IP</li>
                        </ul>
                        <h4>Operators:</h4>
                        <ul>
                            <li><code>AND</code> - Combine filters (default)</li>
                            <li><code>OR</code> - Match any filter</li>
                            <li><code>-field:value</code> - Negate (exclude)</li>
                        </ul>
                        <h4>Complex Queries:</h4>
                        <ul>
                            <li><code>host:ubuntu AND severity:4</code></li>
                            <li><code>user:root OR user:admin</code></li>
                            <li><code>-user:guest</code> (exclude guest)</li>
                            <li><code>\"failed login attempt\"</code> (search raw message)</li>
                        </ul>
                        <h4>Field Aliases:</h4>
                        <ul>
                            <li>host/hostname, user/username, ip/source_ip, os/os_type</li>
                            <li>type/eventtype/event_type</li>
                            <li>message/msg/raw_message</li>
                        </ul>
                    </div>

                    <!-- Applied Filters Display -->
                    <div class="applied-filters" id="applied-filters">
                        <!-- Filter chips will be inserted here by JavaScript -->
                    </div>

                    <!-- Quick Filters -->
                    <div class="quick-filters-row">
                        <div class="quick-filter-group">
                            <label class="quick-filter-label">Host</label>
                            <select id="quick-filter-host" class="quick-filter-select" onchange="onQuickFilterChange()">
                                <option value="">All Hosts</option>
                            </select>
                        </div>
                        <div class="quick-filter-group">
                            <label class="quick-filter-label">User</label>
                            <select id="quick-filter-user" class="quick-filter-select" onchange="onQuickFilterChange()">
                                <option value="">All Users</option>
                            </select>
                        </div>
                        <div class="quick-filter-group">
                            <label class="quick-filter-label">Severity</label>
                            <select id="quick-filter-severity" class="quick-filter-select" onchange="onQuickFilterChange()">
                                <option value="">All Severities</option>
                                <option value="1">Info (1)</option>
                                <option value="2">Low (2)</option>
                                <option value="3">Medium (3)</option>
                                <option value="4">High (4)</option>
                                <option value="5">Critical (5)</option>
                            </select>
                        </div>
                        <div class="quick-filter-group">
                            <label class="quick-filter-label">Event Type</label>
                            <select id="quick-filter-type" class="quick-filter-select" onchange="onQuickFilterChange()">
                                <option value="">All Types</option>
                                <option value="LOGIN_FAIL">LOGIN_FAIL</option>
                                <option value="SUDO_ESCALATION">SUDO_ESCALATION</option>
                                <option value="DNS_BLOCK">DNS_BLOCK</option>
                                <option value="CRITICAL_ERROR">CRITICAL_ERROR</option>
                                <option value="ACCOUNT_CREATE">ACCOUNT_CREATE</option>
                                <option value="LOG_TAMPERING">LOG_TAMPERING</option>
                                <option value="CONNECTION_BLOCKED">CONNECTION_BLOCKED</option>
                                <option value="PORT_SCAN">PORT_SCAN</option>
                            </select>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="search-actions">
                        <button class="reset-filters-btn" onclick="resetAllFilters()">‚ü≤ RESET FILTERS</button>
                    </div>
                </div>


                <div class="table-box full-width">
                    <div class="section-title">SECURITY EVENT LOG</div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Type</th>
                                <th>Host</th>
                                <th>User</th>
                                <th>Severity</th>
                                <th>Message</th>
                            </tr>
                        </thead>
                            <tbody id="table-events">
                                <tr><td colspan="6" style="text-align: center; padding: 10px; color: #FFCC00;">Loading events...</td></tr>
                            </tbody>
                    </table>

                    <!-- Pagination Controls -->
                    <div class="pagination-container">
                        <button class="pagination-btn" id="btn-prev-page" onclick="goToPreviousPage()" disabled>‚Üê PREV</button>
                        <div class="pagination-info">
                            <span id="pagination-info-text">Page 1 of 1</span>
                        </div>
                        <button class="pagination-btn" id="btn-next-page" onclick="goToNextPage()" disabled>NEXT ‚Üí</button>
                        <span style="color: #FFCC00; font-family: 'Orbitron', sans-serif; font-size: 12px;">|</span>
                        <span style="color: #FFCC00; font-family: 'Orbitron', sans-serif; font-size: 11px; text-transform: uppercase;">Go to page:</span>
                        <input type="number" id="pagination-go-to-page" class="pagination-input" min="1" value="1" placeholder="Page #" onkeypress="if(event.key==='Enter') goToPage(parseInt(this.value))">
                        <button class="pagination-btn" onclick="goToPage(parseInt(document.getElementById('pagination-go-to-page').value))">GO</button>
                    </div>
                </div>
            </div>

            <!-- HOSTS PAGE -->
            <div id="page-hosts" class="page">
                <div class="content-sections">
                    <div class="table-box">
                        <div class="section-title">ACTIVE SYSTEMS</div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Hostname</th>
                                    <th>OS</th>
                                    <th>Last Seen</th>
                                </tr>
                            </thead>
                            <tbody id="table-active-hosts">
                                <tr><td colspan="3" style="text-align: center; padding: 10px; color: #FFCC00;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="table-box">
                        <div class="section-title">OFFLINE SYSTEMS</div>
                        <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                            <button id="btn-remove-inactive" class="export-btn" style="background: #FF3366;">üóëÔ∏è REMOVE INACTIVE</button>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Hostname</th>
                                    <th>OS</th>
                                    <th>Last Seen</th>
                                </tr>
                            </thead>
                            <tbody id="table-inactive-hosts">
                                <tr><td colspan="3" style="text-align: center; padding: 10px; color: #FFCC00;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- THREATS PAGE -->
            <div id="page-threats" class="page">
                <div class="table-box full-width">
                    <div class="section-title">TOP THREAT SOURCES</div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Source IP</th>
                                <th>Events</th>
                                <th>Max Severity</th>
                                <th>Types</th>
                            </tr>
                        </thead>
                            <tbody id="table-threats">
                                <tr><td colspan="4" style="text-align: center; padding: 10px; color: #FFCC00;">Loading...</td></tr>
                            </tbody>
                    </table>
                </div>
            </div>

            <!-- ALERTS PAGE -->
            <div id="page-alerts" class="page">
                
                <!-- ALERT CONFIGURATION PANEL -->
                <div class="search-filter-panel" style="border-left-color: #FF3366; border-color: #FF3366;">
                    <div class="search-filter-title" style="color: #FF3366;">ALERT RULES & THRESHOLDS</div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        
                        <div class="quick-filter-group">
                            <label class="quick-filter-label" style="color: #FF3366;">Minimum Severity to Alert</label>
                            <select id="alert-severity" class="quick-filter-select" style="border-color: #FF3366;">
                                <option value="1">Info (1+)</option>
                                <option value="2">Low (2+)</option>
                                <option value="3">Medium (3+)</option>
                                <option value="4">High (4+)</option>
                                <option value="5">Critical (5)</option>
                            </select>
                        </div>

                        <div class="quick-filter-group">
                            <label class="quick-filter-label" style="color: #FF3366;">Host Inactive Timeout (Minutes)</label>
                            <input type="number" id="alert-inactive" class="search-input" value="15" min="1" style="border-color: #FF3366;">
                        </div>

                        <div class="quick-filter-group">
                            <label class="quick-filter-label" style="color: #FF3366;">Quiet Hours (UTC)</label>
                            <input type="text" id="alert-quiet" class="search-input" placeholder="e.g. 22:00-06:00" style="border-color: #FF3366;">
                        </div>

                        <div class="quick-filter-group" style="display: flex; align-items: flex-end;">
                            <div style="display: flex; align-items: center; gap: 10px; height: 42px; background: #1a1a1a; padding: 0 15px; border: 2px solid #FF3366; border-radius: 2px; width: 100%;">
                                <input type="checkbox" id="alert-enable" style="width: 20px; height: 20px; cursor: pointer;">
                                <label for="alert-enable" style="color: #FFCC00; font-family: 'Orbitron', sans-serif; font-size: 14px; cursor: pointer; font-weight: 700;">ENABLE ALERTS</label>
                            </div>
                        </div>
                    </div>

                    <div class="search-actions">
                        <button id="btn-save-alerts" class="export-btn" style="background: #FF3366; border-color: #FF3366; color: #000;">üíæ SAVE ALERT RULES</button>
                    </div>
                </div>

                <div class="table-box full-width">
                    <div class="section-title">CRITICAL SECURITY ALERTS (SEVERITY 4-5)</div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Type</th>
                                <th>Host</th>
                                <th>User</th>
                                <th>Severity</th>
                                <th>Message</th>
                            </tr>
                        </thead>
                            <tbody id="table-alerts">
                                <tr><td colspan="6" style="text-align: center; padding: 10px; color: #FFCC00;">Loading alerts...</td></tr>
                            </tbody>
                    </table>
                </div>
            </div>

            <!-- SETTINGS PAGE -->
            <div id="page-settings" class="page">
                <div class="section-box full-width">
                    <div class="section-title">DISPLAY PREFERENCES</div>
                    <div style="padding: 20px; color: #FFCC00; font-size: 17px;">
                        <div style="margin-bottom: 15px;">
                            <label for="settings-timezone" style="color: #00CCFF; font-weight: 700; display: block; margin-bottom: 5px;">Dashboard Timezone:</label>
                            <select id="settings-timezone" onchange="saveTimezonePreference()" style="padding: 8px; width: 100%; max-width: 400px; background: #1a1a1a; color: #FFCC00; border: 2px solid #00CCFF; font-family: 'Orbitron', sans-serif;">
                                <option value="">Browser Default (Auto)</option>
                            </select>
                            <div style="font-size: 12px; color: #888; margin-top: 5px;">All times will be converted to this timezone.</div>
                        </div>
                    </div>
                </div>

                <div class="section-box full-width">
                    <div class="section-title">API CONFIGURATION</div>
                    <div style="padding: 20px; color: #FFCC00; font-size: 17px;">
                        <p style="margin-bottom: 12px;"><strong style="color: #FFCC00;">API URL:</strong> <span id="settings-api-url" style="color: #FFCC00;">-</span></p>
                        <p style="margin-bottom: 12px;"><strong style="color: #FFCC00;">API Key:</strong> <span id="settings-api-key" style="color: #FFCC00;">-</span></p>
                    </div>
                </div>

                <div class="section-box full-width">
                    <div class="section-title">TELEGRAM ALERTS CONFIGURATION</div>
                    <div style="padding: 20px; color: #FFCC00; font-size: 17px;">
                        <div style="margin-bottom: 15px;">
                            <label for="telegram-bot-token" style="color: #00FF99; font-weight: 700; display: block; margin-bottom: 5px;">Bot Token:</label>
                            <input type="password" id="telegram-bot-token" placeholder="Enter Telegram Bot Token" style="padding: 8px; width: 100%; max-width: 400px; background: #1a1a1a; color: #FFCC00; border: 2px solid #00FF99; font-family: 'Orbitron', sans-serif; box-sizing: border-box;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label for="telegram-chat-id" style="color: #00FF99; font-weight: 700; display: block; margin-bottom: 5px;">Chat ID:</label>
                            <input type="text" id="telegram-chat-id" placeholder="Enter Telegram Chat ID" style="padding: 8px; width: 100%; max-width: 400px; background: #1a1a1a; color: #FFCC00; border: 2px solid #00FF99; font-family: 'Orbitron', sans-serif; box-sizing: border-box;">
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                            <button id="btn-telegram-test" class="export-btn" style="background: #00FF99;">‚úì TEST CONNECTION</button>
                            <button id="btn-telegram-save" class="export-btn" style="background: #0099FF;">üíæ SAVE SETTINGS</button>
                        </div>
                        <div id="telegram-status" style="margin-top: 15px; padding: 10px; border-left: 4px solid #FF9900; background: #1a1a1a; display: none;">
                            <span id="telegram-status-text">-</span>
                        </div>
                    </div>
                </div>

                <div class="section-box full-width">
                    <div class="section-title">SYSTEM INFORMATION</div>
                    <div style="padding: 20px; color: #FFCC00; font-size: 17px;">
                        <p style="margin-bottom: 12px;">Heimdall Mini-SIEM v2.0 | Last Updated: 2025-12-06</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Dialog -->
    <div id="export-dialog" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10002; overflow-y: auto;">
        <div style="background: #000000; border: 3px solid #FF9900; margin: 40px auto; max-width: 600px; padding: 30px; border-radius: 2px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: #FFCC00; margin: 0; font-size: 24px; font-family: 'Orbitron', sans-serif;">EXPORT OPTIONS</h2>
                <button onclick="closeExportDialog()" style="background: #FF3366; color: #000; border: none; padding: 8px 16px; cursor: pointer; font-weight: bold; border-radius: 2px;">‚úï CLOSE</button>
            </div>

            <div style="background: rgba(0, 204, 255, 0.1); border-left: 4px solid #00CCFF; padding: 12px; margin-bottom: 20px; border-radius: 2px;">
                <p style="color: #00CCFF; margin: 0; font-size: 13px; font-family: 'Orbitron', sans-serif; line-height: 1.5;">
                    <strong>üí° Note:</strong> Your active search filters will be applied to the export.<br>
                    Use the options below to further refine the exported data.
                </p>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="color: #00FF99; display: block; margin-bottom: 5px; font-weight: 700;">Start Date:</label>
                <input type="date" id="export-start-date" style="width: 100%; padding: 8px; background: #1a1a1a; color: #FFCC00; border: 2px solid #00FF99; font-family: 'Orbitron', sans-serif; box-sizing: border-box;">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="color: #00FF99; display: block; margin-bottom: 5px; font-weight: 700;">End Date:</label>
                <input type="date" id="export-end-date" style="width: 100%; padding: 8px; background: #1a1a1a; color: #FFCC00; border: 2px solid #00FF99; font-family: 'Orbitron', sans-serif; box-sizing: border-box;">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="color: #0099FF; display: block; margin-bottom: 5px; font-weight: 700;">Hostname (contains):</label>
                <input type="text" id="export-host" placeholder="Leave blank for all hosts" style="width: 100%; padding: 8px; background: #1a1a1a; color: #FFCC00; border: 2px solid #0099FF; font-family: 'Orbitron', sans-serif; box-sizing: border-box;">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="color: #FF3366; display: block; margin-bottom: 5px; font-weight: 700;">Minimum Severity:</label>
                <select id="export-severity" style="width: 100%; padding: 8px; background: #1a1a1a; color: #FFCC00; border: 2px solid #FF3366; font-family: 'Orbitron', sans-serif; box-sizing: border-box;">
                    <option value="">All Severities</option>
                    <option value="1">Info (1+)</option>
                    <option value="2">Low (2+)</option>
                    <option value="3">Medium (3+)</option>
                    <option value="4">High (4+)</option>
                    <option value="5">Critical (5)</option>
                </select>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="color: #00CCFF; display: block; margin-bottom: 5px; font-weight: 700;">Event Type:</label>
                <select id="export-event-type" style="width: 100%; padding: 8px; background: #1a1a1a; color: #FFCC00; border: 2px solid #00CCFF; font-family: 'Orbitron', sans-serif; box-sizing: border-box;">
                    <option value="">All Event Types</option>
                    <option value="LOGIN_FAIL">LOGIN_FAIL</option>
                    <option value="SUDO_ESCALATION">SUDO_ESCALATION</option>
                    <option value="DNS_BLOCK">DNS_BLOCK</option>
                    <option value="CRITICAL_ERROR">CRITICAL_ERROR</option>
                    <option value="ACCOUNT_CREATE">ACCOUNT_CREATE</option>
                    <option value="LOG_TAMPERING">LOG_TAMPERING</option>
                    <option value="CONNECTION_BLOCKED">CONNECTION_BLOCKED</option>
                    <option value="PORT_SCAN">PORT_SCAN</option>
                </select>
            </div>

            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="exportEventsAsCSV()" class="export-btn" style="background: #0099FF; flex: 1;">üì• CSV EXPORT</button>
                <button onclick="exportEventsAsJSON()" class="export-btn" style="background: #FF3366; flex: 1;">üì• JSON EXPORT</button>
            </div>
        </div>
    </div>

    <!-- Threat Details Dialog -->
    <div id="threat-dialog" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10003; overflow-y: auto;">
        <div style="background: #000000; border: 3px solid #FF3366; margin: 40px auto; max-width: 800px; padding: 0; border-radius: 2px; box-shadow: 0 0 30px rgba(255, 51, 102, 0.2);">
            <!-- Header -->
            <div style="background: rgba(255, 51, 102, 0.1); padding: 20px; border-bottom: 2px solid #FF3366; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="color: #FF3366; font-size: 12px; font-weight: 700; letter-spacing: 2px; margin-bottom: 5px;">THREAT INTELLIGENCE</div>
                    <h2 id="threat-ip" style="color: #FFCC00; margin: 0; font-size: 32px; font-family: 'Orbitron', sans-serif; text-shadow: 0 0 10px rgba(255, 204, 0, 0.3);">0.0.0.0</h2>
                </div>
                <div style="text-align: right;">
                    <div id="threat-severity-badge" style="background: #FF3366; color: #000; padding: 5px 12px; font-weight: 900; font-size: 14px; border-radius: 2px; display: inline-block;">CRITICAL</div>
                </div>
            </div>

            <!-- Content -->
            <div style="padding: 30px;">
                <!-- Key Metrics -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
                    <div style="background: #1a1a1a; padding: 15px; border-left: 4px solid #FF9900;">
                        <div style="color: #888; font-size: 12px; margin-bottom: 5px;">TOTAL EVENTS</div>
                        <div id="threat-total-events" style="color: #FFCC00; font-size: 24px; font-weight: 700;">0</div>
                    </div>
                    <div style="background: #1a1a1a; padding: 15px; border-left: 4px solid #00CCFF;">
                        <div style="color: #888; font-size: 12px; margin-bottom: 5px;">FIRST SEEN</div>
                        <div id="threat-first-seen" style="color: #00CCFF; font-size: 16px; font-weight: 600;">-</div>
                    </div>
                    <div style="background: #1a1a1a; padding: 15px; border-left: 4px solid #00CCFF;">
                        <div style="color: #888; font-size: 12px; margin-bottom: 5px;">LAST SEEN</div>
                        <div id="threat-last-seen" style="color: #00CCFF; font-size: 16px; font-weight: 600;">-</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <!-- Attack Vector -->
                    <div>
                        <h3 style="color: #FF9900; font-size: 16px; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 5px;">ATTACK PATTERNS</h3>
                        <div id="threat-types-list" style="display: flex; flex-direction: column; gap: 10px;">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- Targets -->
                    <div>
                        <h3 style="color: #00FF99; font-size: 16px; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 5px;">TARGETED SYSTEMS & USERS</h3>
                        
                        <div style="margin-bottom: 15px;">
                            <div style="color: #888; font-size: 12px; margin-bottom: 5px;">AFFECTED HOSTS</div>
                            <div id="threat-hosts-list" style="display: flex; flex-wrap: wrap; gap: 8px;">
                                <!-- Chips -->
                            </div>
                        </div>

                        <div>
                            <div style="color: #888; font-size: 12px; margin-bottom: 5px;">TARGETED USERNAMES</div>
                            <div id="threat-users-list" style="display: flex; flex-wrap: wrap; gap: 8px;">
                                <!-- Chips -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer Actions -->
            <div style="background: #111; padding: 20px; border-top: 1px solid #333; display: flex; justify-content: flex-end; gap: 15px;">
                <button onclick="document.getElementById('threat-dialog').style.display='none'" style="background: transparent; color: #888; border: 1px solid #444; padding: 10px 20px; cursor: pointer; font-weight: 600; border-radius: 2px;">CLOSE</button>
                <button id="btn-threat-drilldown" style="background: #FF9900; color: #000; border: none; padding: 10px 20px; cursor: pointer; font-weight: 700; border-radius: 2px; font-family: 'Orbitron', sans-serif;">üîç VIEW RAW LOGS</button>
            </div>
        </div>
    </div>

    <!-- Host Details Dialog -->
    <div id="host-dialog" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10003; overflow-y: auto;">
        <div style="background: #000000; border: 3px solid #00FF99; margin: 40px auto; max-width: 800px; padding: 0; border-radius: 2px; box-shadow: 0 0 30px rgba(0, 255, 153, 0.2);">
            <!-- Header -->
            <div style="background: rgba(0, 255, 153, 0.1); padding: 20px; border-bottom: 2px solid #00FF99; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="color: #00FF99; font-size: 12px; font-weight: 700; letter-spacing: 2px; margin-bottom: 5px;">SYSTEM INTELLIGENCE</div>
                    <h2 id="host-hostname" style="color: #FFCC00; margin: 0; font-size: 32px; font-family: 'Orbitron', sans-serif;">HOSTNAME</h2>
                </div>
                <div style="text-align: right;">
                    <div id="host-status-badge" style="background: #00FF99; color: #000; padding: 5px 12px; font-weight: 900; font-size: 14px; border-radius: 2px; display: inline-block;">ACTIVE</div>
                </div>
            </div>

            <!-- Content -->
            <div class="padding-30" style="padding: 30px;">
                <!-- Key Metrics -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
                    <div style="background: #1a1a1a; padding: 15px; border-left: 4px solid #FF9900;">
                        <div style="color: #888; font-size: 12px; margin-bottom: 5px;">TOTAL EVENTS (24H)</div>
                        <div id="host-total-events" style="color: #FFCC00; font-size: 24px; font-weight: 700;">0</div>
                    </div>
                    <div style="background: #1a1a1a; padding: 15px; border-left: 4px solid #00CCFF;">
                        <div style="color: #888; font-size: 12px; margin-bottom: 5px;">OS TYPE</div>
                        <div id="host-os-type" style="color: #00CCFF; font-size: 16px; font-weight: 600;">-</div>
                    </div>
                    <div style="background: #1a1a1a; padding: 15px; border-left: 4px solid #00CCFF;">
                        <div style="color: #888; font-size: 12px; margin-bottom: 5px;">LAST SEEN</div>
                        <div id="host-last-seen" style="color: #00CCFF; font-size: 16px; font-weight: 600;">-</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <!-- Activity -->
                    <div>
                        <h3 style="color: #FF9900; font-size: 16px; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 5px;">EVENT ACTIVITY</h3>
                        <div id="host-types-list" style="display: flex; flex-direction: column; gap: 10px;">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- Users -->
                    <div>
                        <h3 style="color: #00CCFF; font-size: 16px; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 5px;">ACTIVE USERS</h3>
                        <div id="host-users-list" style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <!-- Chips -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer Actions -->
            <div style="background: #111; padding: 20px; border-top: 1px solid #333; display: flex; justify-content: flex-end; gap: 15px;">
                <button onclick="document.getElementById('host-dialog').style.display='none'" style="background: transparent; color: #888; border: 1px solid #444; padding: 10px 20px; cursor: pointer; font-weight: 600; border-radius: 2px;">CLOSE</button>
                <button id="btn-host-drilldown" style="background: #00FF99; color: #000; border: none; padding: 10px 20px; cursor: pointer; font-weight: 700; border-radius: 2px; font-family: 'Orbitron', sans-serif;">üîç VIEW HOST LOGS</button>
            </div>
        </div>
    </div>

    <!-- Event Details Dialog -->
    <div id="event-dialog" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10004; overflow-y: auto;">
        <div style="background: #000000; border: 3px solid #00CCFF; margin: 40px auto; max-width: 700px; padding: 0; border-radius: 2px; box-shadow: 0 0 30px rgba(0, 204, 255, 0.2);">
            <!-- Header -->
            <div style="background: rgba(0, 204, 255, 0.1); padding: 20px; border-bottom: 2px solid #00CCFF; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="color: #00CCFF; font-size: 12px; font-weight: 700; letter-spacing: 2px; margin-bottom: 5px;">EVENT DETAILS</div>
                    <h2 id="event-type-title" style="color: #FFCC00; margin: 0; font-size: 28px; font-family: 'Orbitron', sans-serif;">LOGIN_FAIL</h2>
                </div>
                <div style="text-align: right;">
                    <div id="event-severity-badge" style="background: #00CCFF; color: #000; padding: 5px 12px; font-weight: 900; font-size: 14px; border-radius: 2px; display: inline-block;">INFO</div>
                </div>
            </div>

            <!-- Content -->
            <div style="padding: 30px;">
                <!-- Grid -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <div style="color: #888; font-size: 12px;">TIMESTAMP</div>
                        <div id="event-timestamp" style="color: #FFF; font-size: 15px; font-weight: 500;">-</div>
                    </div>
                    <div>
                        <div style="color: #888; font-size: 12px;">SOURCE HOST</div>
                        <div id="event-host" style="color: #00FF99; font-size: 15px; font-weight: 500; cursor: pointer;">-</div>
                    </div>
                    <div>
                        <div style="color: #888; font-size: 12px;">USER</div>
                        <div id="event-user" style="color: #FFF; font-size: 15px; font-weight: 500;">-</div>
                    </div>
                    <div>
                        <div style="color: #888; font-size: 12px;">SOURCE IP</div>
                        <div id="event-ip" style="color: #FF9900; font-size: 15px; font-weight: 500; cursor: pointer;">-</div>
                    </div>
                </div>

                <!-- Raw Message -->
                <div style="margin-top: 20px;">
                    <div style="color: #888; font-size: 12px; margin-bottom: 5px;">RAW LOG MESSAGE</div>
                    <div id="event-message" style="background: #111; border: 1px solid #333; padding: 15px; color: #DDD; font-family: monospace; font-size: 13px; line-height: 1.5; white-space: pre-wrap; word-break: break-all; max-height: 200px; overflow-y: auto;"></div>
                </div>
                
                <!-- ID -->
                <div style="margin-top: 15px; text-align: right;">
                    <span style="color: #444; font-size: 11px; font-family: monospace;" id="event-id">ID: -</span>
                </div>
            </div>

            <!-- Footer Actions -->
            <div style="background: #111; padding: 20px; border-top: 1px solid #333; display: flex; justify-content: flex-end; gap: 15px;">
                <button onclick="document.getElementById('event-dialog').style.display='none'" style="background: transparent; color: #888; border: 1px solid #444; padding: 10px 20px; cursor: pointer; font-weight: 600; border-radius: 2px;">CLOSE</button>
                <button id="btn-copy-json" style="background: #00CCFF; color: #000; border: none; padding: 10px 20px; cursor: pointer; font-weight: 700; border-radius: 2px; font-family: 'Orbitron', sans-serif;">üìã COPY JSON</button>
            </div>
        </div>
    </div>

    <script>
        window.API_CONFIG = {
            api_url: 'http://localhost:8010',
            api_key: 'default-insecure-key-change-me'
        };

        const API_URL = window.API_CONFIG.api_url;
        const API_KEY = window.API_CONFIG.api_key;

        // Validate API configuration
        if (!API_URL || API_URL.includes('undefined') || API_URL.includes('null')) {
            console.error('Invalid API_URL configuration:', API_URL);
            alert('ERROR: API URL is not configured correctly. Please check the API_CONFIG.');
        }

        // Test API connection on load
        async function testAPIConnection() {
            try {
                console.log('Testing API connection to:', API_URL);
                const response = await fetch(`${API_URL}/health`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úì API connection successful:', data);
                    return true;
                } else {
                    console.warn('‚ö† API health check returned:', response.status);
                    return false;
                }
            } catch (err) {
                console.error('‚úó API connection test failed:', err);
                console.error('This could be due to:');
                console.error('1. API server not running');
                console.error('2. Browser extension blocking requests');
                console.error('3. CORS configuration issue');
                console.error('4. Network connectivity problem');
                return false;
            }
        }
        const charts = {};
        let cachedData = {events: [], hosts: {active: [], inactive: []}, metrics: {}};

        // ==================== FILTER STATE MANAGEMENT ====================
        let filterState = {
            searchQuery: '',
            parsedQuery: null,
            quickFilters: {
                source_host: '',
                user: '',
                severity: '',
                event_type: ''
            },
            currentPage: 1,
            pageSize: 100,
            totalCount: 0,
            totalPages: 0
        };

        let allRawEvents = []; // Store all events from API before filtering
        let searchDebounceTimer = null; // Debounce timer for live search

        // ==================== LIVE SEARCH HANDLER ====================
        /**
         * Handle live search input changes with debouncing (500ms)
         * Triggers automatic filtering as user types
         */
        function onSearchInputChange() {
            // Clear previous debounce timer
            if (searchDebounceTimer) {
                clearTimeout(searchDebounceTimer);
            }

            // Set new debounce timer - only search after user stops typing for 500ms
            searchDebounceTimer = setTimeout(() => {
                const queryValue = document.getElementById('search-query').value;

                // Only perform search if query changed or is empty
                if (queryValue !== filterState.searchQuery) {
                    filterState.searchQuery = queryValue;
                    filterState.parsedQuery = parseSearchQuery(filterState.searchQuery);
                    filterState.currentPage = 1; // Reset to first page on new search

                    updateAppliedFiltersDisplay();
                    performSearch();
                }
            }, 500); // 500ms debounce delay for efficient filtering
        }

        // ==================== ADVANCED QUERY PARSER ====================
        // Parses Splunk-like search syntax into structured filters

        /**
         * Parse a Splunk-like search query into structured filter tokens
         *
         * Syntax Examples:
         * - host:ubuntu severity:5
         * - user:root OR user:admin
         * - "raw message search"
         * - (host:ubuntu OR host:debian) AND severity:4
         * - -user:guest (negation)
         *
         * @param {string} query - The search query string
         * @returns {Object} Parsed filter object with tokens and metadata
         */
        function parseSearchQuery(query) {
            if (!query || typeof query !== 'string') {
                return { tokens: [], raw_query: '', error: null };
            }

            const tokens = [];
            let error = null;

            try {
                // Tokenize the query - split while respecting quoted strings
                const tokenRegex = /("(?:\\.|[^"\\])*"|\S+)/g;
                const rawTokens = query.match(tokenRegex) || [];

                let i = 0;
                let currentOperator = 'AND'; // Default operator

                while (i < rawTokens.length) {
                    const rawToken = rawTokens[i];

                    // Check for logical operators
                    if (rawToken.toUpperCase() === 'AND') {
                        currentOperator = 'AND';
                        i++;
                        continue;
                    }
                    if (rawToken.toUpperCase() === 'OR') {
                        currentOperator = 'OR';
                        i++;
                        continue;
                    }

                    // Handle negation (NOT or -)
                    let negated = false;
                    let token = rawToken;

                    if (token.startsWith('-')) {
                        negated = true;
                        token = token.substring(1);
                    } else if (token.toUpperCase() === 'NOT') {
                        negated = true;
                        i++;
                        if (i < rawTokens.length) {
                            token = rawTokens[i];
                        } else {
                            error = 'NOT operator requires a value';
                            break;
                        }
                    }

                    // Parse field:value syntax
                    let field = null;
                    let value = null;
                    let isValueQuoted = false;

                    if (token.includes(':')) {
                        const parts = token.split(':', 2);
                        field = parts[0].toLowerCase();
                        value = parts[1];

                        // Remove quotes if present
                        if (value.startsWith('"') && value.endsWith('"')) {
                            value = value.slice(1, -1);
                            isValueQuoted = true;
                        }
                    } else {
                        // Bare value - search across message/raw_message
                        field = 'raw_message';
                        value = token;

                        // Remove quotes if present
                        if (value.startsWith('"') && value.endsWith('"')) {
                            value = value.slice(1, -1);
                            isValueQuoted = true;
                        }
                    }

                    // Map common field aliases to standard names
                    const fieldMap = {
                        'host': 'source_host',
                        'hostname': 'source_host',
                        'ip': 'source_ip',
                        'user': 'user',
                        'username': 'user',
                        'type': 'event_type',
                        'eventtype': 'event_type',
                        'event_type': 'event_type',
                        'severity': 'severity',
                        'os': 'os_type',
                        'os_type': 'os_type',
                        'message': 'raw_message',
                        'msg': 'raw_message',
                        'raw_message': 'raw_message',
                        'after': 'start_date',
                        'before': 'end_date',
                        'from': 'start_date',
                        'to': 'end_date'
                    };

                    const standardField = fieldMap[field] || field;

                    tokens.push({
                        field: standardField,
                        value: value,
                        operator: currentOperator,
                        negated: negated,
                        isValueQuoted: isValueQuoted,
                        originalField: field
                    });

                    i++;
                }

                return {
                    tokens: tokens,
                    raw_query: query,
                    error: error,
                    success: !error
                };

            } catch (err) {
                return {
                    tokens: [],
                    raw_query: query,
                    error: `Parse error: ${err.message}`,
                    success: false
                };
            }
        }

        /**
         * Build API query parameters from parsed search query and quick filters
         * Handles combining parsed tokens with quick filter selections
         *
         * @param {Object} parsedQuery - Result from parseSearchQuery()
         * @param {Object} quickFilters - Quick filter selections {host, user, severity, type, ip}
         * @returns {Object} API query parameters object
         */
        function buildApiParams(parsedQuery, quickFilters = {}) {
            const params = {};

            // Add quick filters first (they override parsed query for same field)
            if (quickFilters.source_host) params.source_host = quickFilters.source_host;
            if (quickFilters.user) params.user = quickFilters.user;
            if (quickFilters.severity) params.severity = parseInt(quickFilters.severity);
            if (quickFilters.severity_min) params.severity_min = parseInt(quickFilters.severity_min);
            if (quickFilters.event_type) params.event_type = quickFilters.event_type;
            if (quickFilters.source_ip) params.source_ip = quickFilters.source_ip;
            if (quickFilters.os_type) params.os_type = quickFilters.os_type;
            if (quickFilters.start_date) params.start_date = quickFilters.start_date;
            if (quickFilters.end_date) params.end_date = quickFilters.end_date;

            // Process parsed query tokens
            if (parsedQuery && parsedQuery.tokens && Array.isArray(parsedQuery.tokens)) {
                for (const token of parsedQuery.tokens) {
                    if (token.negated) {
                        // For negation, we do client-side filtering instead
                        // This will be handled in applyClientFilters()
                        continue;
                    }

                    switch (token.field) {
                        case 'source_host':
                            if (!params.source_host) params.source_host = token.value;
                            break;
                        case 'user':
                            if (!params.user) params.user = token.value;
                            break;
                        case 'source_ip':
                            if (!params.source_ip) params.source_ip = token.value;
                            break;
                        case 'severity':
                            if (!params.severity) {
                                const sev = parseInt(token.value);
                                if (!isNaN(sev)) params.severity = sev;
                            }
                            break;
                        case 'event_type':
                            if (!params.event_type) params.event_type = token.value;
                            break;
                        case 'os_type':
                            if (!params.os_type) params.os_type = token.value;
                            break;
                        case 'raw_message':
                            if (!params.raw_message) params.raw_message = token.value;
                            break;
                        case 'start_date':
                            if (!params.start_date) params.start_date = token.value;
                            break;
                        case 'end_date':
                            if (!params.end_date) params.end_date = token.value;
                            break;
                    }
                }
            }

            return params;
        }

        /**
         * Apply client-side filters to events (for negation and OR logic)
         * This filters already-fetched events based on complex query logic
         *
         * @param {Array} events - Array of events to filter
         * @param {Object} parsedQuery - Result from parseSearchQuery()
         * @returns {Array} Filtered events
         */
        function applyClientFilters(events, parsedQuery) {
            if (!parsedQuery || !parsedQuery.tokens || parsedQuery.tokens.length === 0) {
                return events;
            }

            return events.filter(event => {
                // Handle AND/OR/NOT logic
                let currentResult = true;
                let currentOperator = 'AND';

                for (const token of parsedQuery.tokens) {
                    let matches = false;

                    // Check if event matches this token
                    const eventValue = String(event[token.field] || '').toLowerCase();
                    const searchValue = String(token.value).toLowerCase();

                    switch (token.field) {
                        case 'severity':
                            const eventSev = parseInt(event.severity) || 0;
                            const searchSev = parseInt(token.value) || 0;
                            matches = eventSev === searchSev;
                            break;
                        case 'source_host':
                        case 'user':
                        case 'source_ip':
                        case 'event_type':
                        case 'os_type':
                            matches = eventValue === searchValue;
                            break;
                        case 'raw_message':
                            matches = eventValue.includes(searchValue);
                            break;
                        default:
                            matches = eventValue.includes(searchValue);
                    }

                    // Apply negation
                    if (token.negated) {
                        matches = !matches;
                    }

                    // Apply operator logic
                    if (currentOperator === 'AND') {
                        currentResult = currentResult && matches;
                    } else if (currentOperator === 'OR') {
                        currentResult = currentResult || matches;
                    }

                    currentOperator = token.operator;
                }

                return currentResult;
            });
        }

        // ==================== SEARCH & FILTER EVENT HANDLERS ====================

        /**
         * Toggle search tips popover
         */
        function toggleSearchTips() {
            const popover = document.getElementById('search-tips-popover');
            if (popover) {
                popover.classList.toggle('show');
            }
        }

        /**
         * Update applied filters display with chips
         */
        function updateAppliedFiltersDisplay() {
            const container = document.getElementById('applied-filters');
            if (!container) return;

            const chips = [];

            // Add search query chip if present
            if (filterState.searchQuery) {
                chips.push(`<div class="filter-chip">Query: <strong>${filterState.searchQuery.substring(0, 50)}${filterState.searchQuery.length > 50 ? '...' : ''}</strong></div>`);
            }

            // Add quick filter chips
            if (filterState.quickFilters.source_host) {
                chips.push(`<div class="filter-chip">Host: <strong>${filterState.quickFilters.source_host}</strong> <span class="filter-chip-remove" onclick="clearQuickFilter('source_host')">√ó</span></div>`);
            }
            if (filterState.quickFilters.user) {
                chips.push(`<div class="filter-chip">User: <strong>${filterState.quickFilters.user}</strong> <span class="filter-chip-remove" onclick="clearQuickFilter('user')">√ó</span></div>`);
            }
            if (filterState.quickFilters.severity) {
                chips.push(`<div class="filter-chip">Severity: <strong>${filterState.quickFilters.severity}</strong> <span class="filter-chip-remove" onclick="clearQuickFilter('severity')">√ó</span></div>`);
            }
            if (filterState.quickFilters.event_type) {
                chips.push(`<div class="filter-chip">Type: <strong>${filterState.quickFilters.event_type}</strong> <span class="filter-chip-remove" onclick="clearQuickFilter('event_type')">√ó</span></div>`);
            }

            container.innerHTML = chips.length > 0 ? chips.join('') : '';
        }

        /**
         * Clear a specific quick filter
         */
        function clearQuickFilter(filterName) {
            filterState.quickFilters[filterName] = '';
            const selectId = `quick-filter-${filterName === 'event_type' ? 'type' : filterName}`;
            const selectElement = document.getElementById(selectId);
            if (selectElement) selectElement.value = '';
            onQuickFilterChange();
        }

        /**
         * Handle quick filter changes
         */
        function onQuickFilterChange() {
            filterState.quickFilters.source_host = document.getElementById('quick-filter-host').value;
            filterState.quickFilters.user = document.getElementById('quick-filter-user').value;
            filterState.quickFilters.severity = document.getElementById('quick-filter-severity').value;
            filterState.quickFilters.event_type = document.getElementById('quick-filter-type').value;

            filterState.currentPage = 1; // Reset to first page
            updateAppliedFiltersDisplay();
            performSearch();
        }

        /**
         * Handle search button click
         */
        function onSearchButtonClick() {
            filterState.searchQuery = document.getElementById('search-query').value;
            filterState.parsedQuery = parseSearchQuery(filterState.searchQuery);
            filterState.currentPage = 1; // Reset to first page

            if (filterState.parsedQuery.error) {
                alert('Search Error: ' + filterState.parsedQuery.error);
                return;
            }

            updateAppliedFiltersDisplay();
            performSearch();
        }

        /**
         * Reset all filters
         */
        function resetAllFilters() {
            filterState.searchQuery = '';
            filterState.parsedQuery = null;
            filterState.quickFilters = {
                source_host: '',
                user: '',
                severity: '',
                event_type: ''
            };
            filterState.currentPage = 1;

            // Clear UI
            document.getElementById('search-query').value = '';
            document.getElementById('quick-filter-host').value = '';
            document.getElementById('quick-filter-user').value = '';
            document.getElementById('quick-filter-severity').value = '';
            document.getElementById('quick-filter-type').value = '';

            updateAppliedFiltersDisplay();
            performSearch();
        }

        /**
         * Perform search with current filters
         */
        function performSearch() {
            // Build API parameters from current filters
            const apiParams = buildApiParams(filterState.parsedQuery, filterState.quickFilters);
            apiParams.offset = (filterState.currentPage - 1) * filterState.pageSize;
            apiParams.limit = filterState.pageSize;

            refreshEventsDataWithFilters(apiParams);
        }

        /**
         * Pagination functions
         */
        function goToPreviousPage() {
            if (filterState.currentPage > 1) {
                filterState.currentPage--;
                document.getElementById('pagination-go-to-page').value = filterState.currentPage;
                performSearch();
            }
        }

        function goToNextPage() {
            if (filterState.currentPage < filterState.totalPages) {
                filterState.currentPage++;
                document.getElementById('pagination-go-to-page').value = filterState.currentPage;
                performSearch();
            }
        }

        function goToPage(pageNum) {
            if (pageNum > 0 && pageNum <= filterState.totalPages) {
                filterState.currentPage = pageNum;
                performSearch();
            } else {
                alert(`Please enter a page number between 1 and ${filterState.totalPages}`);
            }
        }

        /**
         * Refresh events data with specific filter parameters
         */
        function refreshEventsDataWithFilters(apiParams) {
            const url = new URL(API_URL + '/events', window.location.origin);
            Object.keys(apiParams).forEach(key => {
                if (apiParams[key] !== '' && apiParams[key] !== null && apiParams[key] !== undefined) {
                    url.searchParams.append(key, apiParams[key]);
                }
            });

            fetch(url.toString(), {
                headers: { 'api-key': API_KEY }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.events) {
                    allRawEvents = data.events;
                    cachedData.events = applyClientFilters(data.events, filterState.parsedQuery);
                    filterState.totalCount = data.total_count;
                    filterState.totalPages = Math.ceil(data.total_count / filterState.pageSize);

                    updateEventsPageWithFilters();
                    updatePaginationControls();
                }
            })
            .catch(error => console.error('Error fetching filtered events:', error));
        }

        /**
         * Update pagination controls
         */
        function updatePaginationControls() {
            const prevBtn = document.getElementById('btn-prev-page');
            const nextBtn = document.getElementById('btn-next-page');
            const infoText = document.getElementById('pagination-info-text');

            if (prevBtn) prevBtn.disabled = filterState.currentPage <= 1;
            if (nextBtn) nextBtn.disabled = filterState.currentPage >= filterState.totalPages;

            if (infoText) {
                const startRecord = ((filterState.currentPage - 1) * filterState.pageSize) + 1;
                const endRecord = Math.min(filterState.currentPage * filterState.pageSize, filterState.totalCount);
                infoText.textContent = `Page ${filterState.currentPage} of ${filterState.totalPages} (${startRecord}-${endRecord} of ${filterState.totalCount})`;
            }
        }

        /**
         * Update events page with filtered data
         */
        function updateEventsPageWithFilters() {
            const tbody = document.getElementById('table-events');
            if (!tbody) return;

            // Ensure events are sorted by timestamp descending before pagination
            const events = (cachedData.events || []).sort((a, b) => {
                return new Date(b.timestamp) - new Date(a.timestamp);
            });

            if (events.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 15px; color: #FFCC00;">No events match your filters</td></tr>';
                updatePaginationControls();
                return;
            }

            tbody.innerHTML = events.slice(0, filterState.pageSize).map(e => {
                const severityEmoji = ['‚ö™', 'üü¢', 'üü°', 'üü†', 'üî¥'][e.severity] || '‚ö™';
                return `
                    <tr>
                        <td>${formatDate(e.timestamp)}</td>
                        <td>
                            <span onclick="showEventDetails('${e.event_id}')" style="color: #00CCFF; cursor: pointer; text-decoration: underline; font-weight: bold;">
                                ${e.event_type || 'N/A'}
                            </span>
                        </td>
                        <td>${e.source_host || 'Unknown'}</td>
                        <td>${e.user || 'N/A'}</td>
                        <td>${severityEmoji} ${e.severity || 0}</td>
                        <td title="${e.raw_message || ''}">${addDrilldownToIPs((e.raw_message || '-').substring(0, 100))}</td>
                    </tr>
                `;
            }).join('');

            updatePaginationControls();
        }

        // Open export dialog
        function openExportDialog() {
            const dialog = document.getElementById('export-dialog');
            if (dialog) dialog.style.display = 'block';
        }

        function closeExportDialog() {
            const dialog = document.getElementById('export-dialog');
            if (dialog) dialog.style.display = 'none';
        }

        // Filter events based on export options
        /**
         * Get filtered events for export
         * Combines search panel filters + export dialog filters
         * Export dialog filters take precedence over search filters
         */
        function getFilteredEvents() {
            // Start with all raw events (not paginated)
            let events = allRawEvents.length > 0 ? allRawEvents : (cachedData.events || []);

            // First apply search panel filters
            if (filterState.searchQuery || filterState.quickFilters.source_host ||
                filterState.quickFilters.user || filterState.quickFilters.severity ||
                filterState.quickFilters.event_type) {

                // Apply quick filters
                if (filterState.quickFilters.source_host) {
                    events = events.filter(e => e.source_host === filterState.quickFilters.source_host);
                }
                if (filterState.quickFilters.user) {
                    events = events.filter(e => e.user && e.user.toLowerCase().includes(filterState.quickFilters.user.toLowerCase()));
                }
                if (filterState.quickFilters.severity) {
                    const severity = parseInt(filterState.quickFilters.severity);
                    events = events.filter(e => e.severity === severity);
                }
                if (filterState.quickFilters.event_type) {
                    events = events.filter(e => e.event_type === filterState.quickFilters.event_type);
                }

                // Apply parsed search query filters
                if (filterState.parsedQuery && filterState.parsedQuery.tokens.length > 0) {
                    events = applyClientFilters(events, filterState.parsedQuery);
                }
            }

            // Then apply export dialog filters (these override search filters)
            const startDate = document.getElementById('export-start-date').value;
            const endDate = document.getElementById('export-end-date').value;
            const hostFilter = document.getElementById('export-host').value.trim();
            const severityFilter = parseInt(document.getElementById('export-severity').value) || 0;
            const eventTypeFilter = document.getElementById('export-event-type').value;

            // Filter by date range
            if (startDate) {
                const start = new Date(startDate);
                events = events.filter(e => new Date(e.timestamp) >= start);
            }
            if (endDate) {
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999);
                events = events.filter(e => new Date(e.timestamp) <= end);
            }

            // Filter by host
            if (hostFilter) {
                events = events.filter(e => e.source_host && e.source_host.toLowerCase().includes(hostFilter.toLowerCase()));
            }

            // Filter by severity (minimum)
            if (severityFilter > 0) {
                events = events.filter(e => (e.severity || 0) >= severityFilter);
            }

            // Filter by event type
            if (eventTypeFilter) {
                events = events.filter(e => e.event_type === eventTypeFilter);
            }

            return events;
        }

        // Export Events as CSV
        function exportEventsAsCSV() {
            const events = getFilteredEvents();
            if (events.length === 0) {
                alert('No events match the filter criteria');
                return;
            }
            const headers = ['Timestamp', 'Event Type', 'Source Host', 'User', 'Severity', 'OS Type', 'Source IP', 'Message'];
            const rows = events.map(e => [
                e.timestamp || '',
                e.event_type || '',
                e.source_host || '',
                e.user || '',
                e.severity || '',
                e.os_type || '',
                e.source_ip || '',
                (e.raw_message || '').replace(/"/g, '""')
            ]);
            const csv = [headers, ...rows].map(row =>
                row.map(cell => `"${cell}"`).join(',')
            ).join('\n');
            const blob = new Blob([csv], {type: 'text/csv'});
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `heimdall-events-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            closeExportDialog();
        }

        // Export Events as JSON
        function exportEventsAsJSON() {
            const events = getFilteredEvents();
            if (events.length === 0) {
                alert('No events match the filter criteria');
                return;
            }
            const json = JSON.stringify(events, null, 2);
            const blob = new Blob([json], {type: 'application/json'});
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `heimdall-events-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            window.URL.revokeObjectURL(url);
            closeExportDialog();
        }

        // Remove Inactive Hosts
        async function removeInactiveHosts() {
            const inactiveHosts = cachedData.hosts.inactive || [];
            if (inactiveHosts.length === 0) {
                alert('No inactive hosts to remove');
                return;
            }
            if (!confirm(`Remove ${inactiveHosts.length} inactive host(s)? This action cannot be undone.`)) {
                return;
            }
            try {
                for (const host of inactiveHosts) {
                    await fetch(`${API_URL}/hosts/${host.source_host}`, {
                        method: 'DELETE',
                        headers: {'api_key': API_KEY}
                    });
                }
                alert('Inactive hosts removed successfully');
                await refreshHostsData();
                updateHostsPage();
            } catch (err) {
                console.error('Error removing inactive hosts:', err);
                alert('Error removing inactive hosts');
            }
        }

        // Test Telegram Connection
        async function testTelegramConnection() {
            const botToken = document.getElementById('telegram-bot-token').value.trim();
            const chatId = document.getElementById('telegram-chat-id').value.trim();

            if (!botToken || !chatId) {
                showTelegramStatus('Please enter both Bot Token and Chat ID', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/alerts/telegram/test`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'api-key': API_KEY
                    },
                    body: JSON.stringify({bot_token: botToken, chat_id: chatId})
                });
                const result = await response.json();
                if (response.ok) {
                    showTelegramStatus('‚úì Telegram connection successful!', 'success');
                } else {
                    showTelegramStatus('‚úó Connection failed: ' + (result.detail || 'Unknown error'), 'error');
                }
            } catch (err) {
                console.error('Error testing Telegram:', err);
                showTelegramStatus('‚úó Error: ' + err.message, 'error');
            }
        }

        // Save Telegram Settings
        async function saveTelegramSettings() {
            const botToken = document.getElementById('telegram-bot-token').value.trim();
            const chatId = document.getElementById('telegram-chat-id').value.trim();

            if (!botToken || !chatId) {
                showTelegramStatus('Please enter both Bot Token and Chat ID', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/alerts/telegram/config`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'api-key': API_KEY
                    },
                    body: JSON.stringify({bot_token: botToken, chat_id: chatId})
                });
                if (response.ok) {
                    showTelegramStatus('‚úì Telegram settings saved successfully!', 'success');
                    localStorage.setItem('telegram_bot_token', botToken);
                    localStorage.setItem('telegram_chat_id', chatId);
                } else {
                    const result = await response.json();
                    showTelegramStatus('‚úó Save failed: ' + (result.detail || 'Unknown error'), 'error');
                }
            } catch (err) {
                console.error('Error saving Telegram settings:', err);
                showTelegramStatus('‚úó Error: ' + err.message, 'error');
            }
        }

        // Show Telegram Status Message
        function showTelegramStatus(message, type) {
            const statusDiv = document.getElementById('telegram-status');
            const statusText = document.getElementById('telegram-status-text');
            statusDiv.style.display = 'block';
            statusText.textContent = message;
            statusDiv.style.borderLeftColor = type === 'success' ? '#00FF99' : '#FF3366';
            statusDiv.style.color = type === 'success' ? '#00FF99' : '#FF3366';
            if (type === 'success') {
                setTimeout(() => {statusDiv.style.display = 'none';}, 5000);
            }
        }

        // Show Host Details Modal
        async function showHostDetails(hostname) {
            // Find host info from cached hosts first
            const activeHost = cachedData.hosts.active.find(h => (h.hostname === hostname || h.source_host === hostname));
            const inactiveHost = cachedData.hosts.inactive.find(h => (h.hostname === hostname || h.source_host === hostname));
            const hostLogInfo = activeHost || inactiveHost || {hostname: hostname, os_type: 'UNKNOWN', last_seen: null};
            
            // Populate basic info immediately
            document.getElementById('host-hostname').textContent = hostname;
            document.getElementById('host-os-type').textContent = hostLogInfo.os_type || 'UNKNOWN';
            document.getElementById('host-last-seen').textContent = formatDate(hostLogInfo.last_seen || new Date().toISOString());
            
            // Status Badge
            const badge = document.getElementById('host-status-badge');
            if (activeHost) {
                badge.textContent = 'ACTIVE';
                badge.style.background = '#00FF99';
                badge.style.color = '#000';
            } else {
                badge.textContent = 'OFFLINE';
                badge.style.background = '#FF3366';
                badge.style.color = '#FFF';
            }

            // Fetch Log Metrics (Local calculation)
            const events = cachedData.events.filter(e => e.source_host === hostname);
            document.getElementById('host-total-events').textContent = events.length.toLocaleString();
            
            // Render basic log stats
            const types = {};
            const users = new Set();
            events.forEach(e => {
                types[e.event_type] = (types[e.event_type] || 0) + 1;
                if (e.user && e.user !== 'N/A') users.add(e.user);
            });

            // Types List
            const typesContainer = document.getElementById('host-types-list');
            typesContainer.innerHTML = Object.entries(types)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([type, count]) => `
                    <div style="display: flex; align-items: center; justify-content: space-between; background: #222; padding: 8px 12px; border-radius: 2px;">
                        <span style="color: #DDD; font-size: 13px;">${type}</span>
                        <span style="color: #FFCC00; font-weight: 700;">${count}</span>
                    </div>
                `).join('') || '<div style="color: #666; padding: 10px;">No recent events</div>';

            // Users Chips
            const usersContainer = document.getElementById('host-users-list');
            usersContainer.innerHTML = Array.from(users).map(u => 
                `<span style="background: rgba(0, 204, 255, 0.1); border: 1px solid #00CCFF; color: #00CCFF; padding: 4px 10px; font-size: 12px; border-radius: 10px;">${u}</span>`
            ).join('') || '<span style="color: #666;">No users detected</span>';

            // Drilldown Button
            document.getElementById('btn-host-drilldown').onclick = () => {
                document.getElementById('host-dialog').style.display = 'none';
                inspectHost(hostname);
            };

            // Show Dialog
            document.getElementById('host-dialog').style.display = 'block';

            // --- FETCH DETAILED SYSTEM STATUS (RMM) ---
            try {
                const response = await fetch(`${API_URL}/system-status/${hostname}`, {
                    headers: {'api-key': API_KEY}
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.status) {
                        updateHostModalWithRMM(data.status);
                    }
                }
            } catch (err) {
                console.warn("Could not fetch extended system status", err);
            }
        }

        // Helper to render RMM data into the modal
        function updateHostModalWithRMM(status) {
            // Update OS Details if available
            if (status.os_details) {
                document.getElementById('host-os-type').innerHTML = `${status.os_type}<br><span style="font-size:11px; color:#888;">${status.os_details}</span>`;
            }

            // Create or Update Resources Section
            // We'll append this dynamically to the modal content
            let rmmSection = document.getElementById('host-rmm-section');
            if (!rmmSection) {
                rmmSection = document.createElement('div');
                rmmSection.id = 'host-rmm-section';
                rmmSection.style.marginTop = '30px';
                rmmSection.style.borderTop = '1px solid #333';
                rmmSection.style.paddingTop = '20px';
                document.querySelector('#host-dialog .padding-30').appendChild(rmmSection);
            }

            // Helper for progress bars
            const makeBar = (label, pct, color) => `
                <div style="margin-bottom: 10px;">
                    <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:4px; color:#AAA;">
                        <span>${label}</span>
                        <span style="color:${color}; font-weight:bold;">${pct.toFixed(1)}%</span>
                    </div>
                    <div style="height:6px; background:#333; border-radius:3px; overflow:hidden;">
                        <div style="width:${pct}%; height:100%; background:${color}; transition: width 0.5s;"></div>
                    </div>
                </div>`;

            const cpuColor = status.cpu_usage > 80 ? '#FF3366' : '#FF9900';
            const memColor = status.memory_percent > 80 ? '#FF3366' : '#00CCFF';

            // Disk HTML
            const diskHtml = (status.disk_info || []).map(d => `
                <div style="margin-bottom: 8px;">
                    <div style="display:flex; justify-content:space-between; font-size:11px; color:#AAA;">
                        <span>${d.mount}</span>
                        <span>${(d.used / 1024 / 1024 / 1024).toFixed(1)}GB / ${(d.total / 1024 / 1024 / 1024).toFixed(1)}GB</span>
                    </div>
                    <div style="height:4px; background:#333; border-radius:2px; overflow:hidden; margin-top:2px;">
                        <div style="width:${d.percent}%; height:100%; background:${d.percent > 90 ? '#FF3366' : '#00FF99'};"></div>
                    </div>
                </div>
            `).join('');

            // Process HTML
            const procHtml = (status.top_processes || []).map(p => `
                <tr style="border-bottom:1px solid #222;">
                    <td style="padding:4px; font-size:12px; color:#FFF;">${p.name}</td>
                    <td style="padding:4px; font-size:12px; color:#888;">${p.username}</td>
                    <td style="padding:4px; font-size:12px; color:${cpuColor}; text-align:right;">${p.cpu_percent.toFixed(1)}%</td>
                    <td style="padding:4px; font-size:12px; color:${memColor}; text-align:right;">${p.memory_percent.toFixed(1)}%</td>
                </tr>
            `).join('');

            rmmSection.innerHTML = `
                <h3 style="color: #00FF99; font-size: 16px; margin-bottom: 15px; letter-spacing: 1px;">SYSTEM RESOURCES</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <!-- Gauges -->
                    <div>
                        ${makeBar(`CPU (${status.cpu_count} Cores)`, status.cpu_usage, cpuColor)}
                        ${makeBar(`Memory (${(status.memory_total/1024/1024/1024).toFixed(1)} GB)`, status.memory_percent, memColor)}
                        
                        <div style="margin-top: 20px;">
                            <div style="color: #888; font-size: 12px; margin-bottom: 10px;">DISK USAGE</div>
                            ${diskHtml}
                        </div>

                        <div style="margin-top: 20px;">
                            <div style="color: #888; font-size: 12px; margin-bottom: 5px;">BOOT TIME</div>
                            <div style="color: #FFF; font-size: 13px;">${formatDate(status.boot_time)}</div>
                        </div>
                    </div>

                    <!-- Processes -->
                    <div>
                        <div style="color: #888; font-size: 12px; margin-bottom: 10px;">TOP PROCESSES</div>
                        <table style="width:100%; border-collapse:collapse;">
                            <thead>
                                <tr style="color:#888; font-size:11px; text-align:left;">
                                    <th>NAME</th><th>USER</th><th style="text-align:right">CPU</th><th style="text-align:right">MEM</th>
                                </tr>
                            </thead>
                            <tbody>${procHtml}</tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // Show Event Details Modal
        function showEventDetails(eventId) {
            const event = cachedData.events.find(e => e.event_id === eventId);
            if (!event) return;

            document.getElementById('event-type-title').textContent = event.event_type;
            document.getElementById('event-timestamp').textContent = formatDate(event.timestamp);
            document.getElementById('event-host').textContent = event.source_host;
            document.getElementById('event-user').textContent = event.user;
            document.getElementById('event-ip').textContent = event.source_ip;
            document.getElementById('event-message').textContent = event.raw_message;
            document.getElementById('event-id').textContent = `ID: ${event.event_id}`;

            // Severity Badge
            const badge = document.getElementById('event-severity-badge');
            const sevConfig = {
                5: {text: 'CRITICAL', bg: '#FF0000', col: '#FFF'},
                4: {text: 'HIGH', bg: '#FF3366', col: '#FFF'},
                3: {text: 'MEDIUM', bg: '#FF9900', col: '#000'},
                2: {text: 'LOW', bg: '#FFCC00', col: '#000'},
                1: {text: 'INFO', bg: '#00FF99', col: '#000'}
            };
            const sc = sevConfig[event.severity] || sevConfig[1];
            badge.textContent = sc.text;
            badge.style.background = sc.bg;
            badge.style.color = sc.col;

            // Links in modal
            document.getElementById('event-host').onclick = () => {
                document.getElementById('event-dialog').style.display = 'none';
                showHostDetails(event.source_host);
            };
            document.getElementById('event-ip').onclick = () => {
                document.getElementById('event-dialog').style.display = 'none';
                showThreatDetails(event.source_ip);
            };

            // Copy JSON
            document.getElementById('btn-copy-json').onclick = () => {
                navigator.clipboard.writeText(JSON.stringify(event, null, 2));
                const btn = document.getElementById('btn-copy-json');
                const origText = btn.textContent;
                btn.textContent = "‚úì COPIED";
                setTimeout(() => btn.textContent = origText, 2000);
            };

            document.getElementById('event-dialog').style.display = 'block';
        }

        // Inspect Host (Drill-down)
        function inspectHost(hostname) {
            resetAllFilters();
            const query = `host:${hostname}`;
            document.getElementById('search-query').value = query;
            const eventsBtn = document.querySelector('.nav-btn[data-page="events"]');
            if (eventsBtn) eventsBtn.click();
            setTimeout(() => onSearchButtonClick(), 100);
        }

        // Show Threat Details Modal
        function showThreatDetails(ip) {
            let events = cachedData.events.filter(e => e.source_ip === ip);
            
            // Fallback: If no direct source_ip match, look for IP in raw_message
            if (events.length === 0) {
                events = cachedData.events.filter(e => (e.raw_message || '').includes(ip));
            }

            if (events.length === 0) {
                // If still no events, maybe open a toast or alert?
                // For now, let's just inspect it directly in the event log filter
                inspectThreat(ip);
                return;
            }

            // Sort for time
            events.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp)); // Ascending

            // Aggregations
            const firstSeen = events[0].timestamp;
            const lastSeen = events[events.length - 1].timestamp;
            const maxSev = Math.max(...events.map(e => e.severity));
            
            const types = {};
            const hosts = new Set();
            const users = new Set();

            events.forEach(e => {
                types[e.event_type] = (types[e.event_type] || 0) + 1;
                if (e.source_host) hosts.add(e.source_host);
                if (e.user && e.user !== 'N/A' && e.user !== 'unknown') users.add(e.user);
            });

            // Populate UI
            document.getElementById('threat-ip').textContent = ip;
            document.getElementById('threat-total-events').textContent = events.length.toLocaleString();
            document.getElementById('threat-first-seen').textContent = formatDate(firstSeen);
            document.getElementById('threat-last-seen').textContent = formatDate(lastSeen);

            // Severity Badge
            const badge = document.getElementById('threat-severity-badge');
            const sevConfig = {
                5: {text: 'CRITICAL', bg: '#FF0000', col: '#FFF'},
                4: {text: 'HIGH', bg: '#FF3366', col: '#FFF'},
                3: {text: 'MEDIUM', bg: '#FF9900', col: '#000'},
                2: {text: 'LOW', bg: '#FFCC00', col: '#000'},
                1: {text: 'INFO', bg: '#00FF99', col: '#000'}
            };
            const sc = sevConfig[maxSev] || sevConfig[1];
            badge.textContent = sc.text;
            badge.style.background = sc.bg;
            badge.style.color = sc.col;

            // Types List
            const typesContainer = document.getElementById('threat-types-list');
            typesContainer.innerHTML = Object.entries(types)
                .sort((a, b) => b[1] - a[1])
                .map(([type, count]) => `
                    <div style="display: flex; align-items: center; justify-content: space-between; background: #222; padding: 8px 12px; border-radius: 2px;">
                        <span style="color: #DDD; font-size: 13px;">${type}</span>
                        <span style="color: #FFCC00; font-weight: 700;">${count}</span>
                    </div>
                `).join('');

            // Hosts Chips
            const hostsContainer = document.getElementById('threat-hosts-list');
            hostsContainer.innerHTML = Array.from(hosts).map(h => 
                `<span style="background: rgba(0, 255, 153, 0.1); border: 1px solid #00FF99; color: #00FF99; padding: 4px 10px; font-size: 12px; border-radius: 10px;">${h}</span>`
            ).join('') || '<span style="color: #666;">No host info</span>';

            // Users Chips
            const usersContainer = document.getElementById('threat-users-list');
            usersContainer.innerHTML = Array.from(users).map(u => 
                `<span style="background: rgba(0, 204, 255, 0.1); border: 1px solid #00CCFF; color: #00CCFF; padding: 4px 10px; font-size: 12px; border-radius: 10px;">${u}</span>`
            ).join('') || '<span style="color: #666;">No specific user info</span>';

            // Drilldown Button
            document.getElementById('btn-threat-drilldown').onclick = () => {
                document.getElementById('threat-dialog').style.display = 'none';
                inspectThreat(ip);
            };

            // Show Dialog
            document.getElementById('threat-dialog').style.display = 'block';
        }

        // Inspect Threat (Drill-down)
        function inspectThreat(ip) {
            // Reset existing filters
            resetAllFilters();
            
            // Set search query for the IP
            const query = `ip:${ip}`;
            document.getElementById('search-query').value = query;
            
            // Switch to Events page
            const eventsBtn = document.querySelector('.nav-btn[data-page="events"]');
            if (eventsBtn) {
                eventsBtn.click();
            }
            
            // Wait for page switch then trigger search
            setTimeout(() => {
                onSearchButtonClick();
            }, 100);
        }

        // Load Alert Configuration
        async function loadAlertConfig() {
            try {
                const response = await fetch(`${API_URL}/alert-config`, {
                    headers: {'api-key': API_KEY}
                });
                if (response.ok) {
                    const data = await response.json();
                    const config = data.config;
                    
                    if (document.getElementById('alert-severity')) 
                        document.getElementById('alert-severity').value = config.severity_threshold;
                    
                    if (document.getElementById('alert-inactive')) 
                        document.getElementById('alert-inactive').value = config.inactive_threshold_minutes;
                    
                    if (document.getElementById('alert-quiet')) 
                        document.getElementById('alert-quiet').value = config.quiet_hours;
                    
                    if (document.getElementById('alert-enable')) 
                        document.getElementById('alert-enable').checked = config.enable_alerts;
                }
            } catch (err) {
                console.error('Error loading alert config:', err);
            }
        }

        // Save Alert Configuration
        async function saveAlertConfig() {
            const severity = document.getElementById('alert-severity').value;
            const inactive = document.getElementById('alert-inactive').value;
            const quiet = document.getElementById('alert-quiet').value;
            const enabled = document.getElementById('alert-enable').checked;

            try {
                const results = await Promise.all([
                    fetch(`${API_URL}/alert-config/severity-threshold?threshold=${severity}`, {method: 'POST', headers: {'api-key': API_KEY}}),
                    fetch(`${API_URL}/alert-config/inactive-threshold?minutes=${inactive}`, {method: 'POST', headers: {'api-key': API_KEY}}),
                    fetch(`${API_URL}/alert-config/quiet-hours?quiet_hours=${encodeURIComponent(quiet)}`, {method: 'POST', headers: {'api-key': API_KEY}}),
                    fetch(`${API_URL}/alert-config/enable?enabled=${enabled}`, {method: 'POST', headers: {'api-key': API_KEY}})
                ]);

                if (results.every(r => r.ok)) {
                    alert('‚úì Alert configuration saved successfully!');
                } else {
                    alert('‚ö† Some settings failed to save. Check API logs.');
                }
            } catch (err) {
                console.error('Error saving alert config:', err);
                alert('Error saving configuration: ' + err.message);
            }
        }

        // Navigation handler
        function setupNavigation() {
            const buttons = document.querySelectorAll('.nav-btn');

            buttons.forEach(btn => {
                btn.addEventListener('click', async () => {
                    const pageName = btn.getAttribute('data-page');

                    // Remove active class from all buttons and pages
                    buttons.forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));

                    // Add active class to clicked button and corresponding page
                    btn.classList.add('active');
                    const page = document.getElementById(`page-${pageName}`);
                    if (page) page.classList.add('active');

                    // Save current page to localStorage
                    localStorage.setItem('lastPage', pageName);

                    // Refresh data and populate page
                    if (pageName === 'dashboard') {
                        await loadData();
                    } else if (pageName === 'events') {
                        await refreshEventsData();
                        populateQuickFilters();
                        // Use cached events and apply any active filters
                        cachedData.events = allRawEvents.length > 0 ? allRawEvents : (cachedData.events || []);
                        cachedData.events = applyClientFilters(cachedData.events, filterState.parsedQuery);
                        filterState.totalCount = cachedData.events.length;
                        filterState.totalPages = Math.ceil(filterState.totalCount / filterState.pageSize);
                        updateEventsPageWithFilters();
                        updatePaginationControls();
                    } else if (pageName === 'hosts') {
                        await refreshHostsData();
                        updateHostsPage();
                    } else if (pageName === 'threats') {
                        // Threats page needs both events and metrics
                        await Promise.all([refreshEventsData(), refreshMetricsData()]);
                        updateThreatsPage();
                    } else if (pageName === 'alerts') {
                        // Alerts page can use filtered query for better performance
                        await refreshEventsData();
                        await loadAlertConfig(); // Load config
                        updateAlertsPage();
                    } else if (pageName === 'settings') {
                        updateSettingsPage();
                    }
                });
            });
        }

        // Helper to add drilldown links to IPs in text
        function addDrilldownToIPs(text) {
            if (!text) return '-';
            // Simple IPv4 regex
            const ipRegex = /\b((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\b/g;
            return text.replace(ipRegex, (match) => {
                return `<span onclick="event.stopPropagation(); showThreatDetails('${match}')" style="color: #FF9900; cursor: pointer; text-decoration: underline; font-weight: bold;">${match}</span>`;
            });
        }

        // Timezone Helper
        function saveTimezonePreference() {
            const tz = document.getElementById('settings-timezone').value;
            localStorage.setItem('dashboard_timezone', tz);
            // Reload data to apply new timezone to charts/tables
            loadData();
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            const tz = localStorage.getItem('dashboard_timezone');
            
            const options = {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit', second: '2-digit',
                timeZoneName: 'short'
            };
            
            if (tz) options.timeZone = tz;
            
            try {
                return date.toLocaleString(undefined, options);
            } catch (e) {
                return date.toLocaleString();
            }
        }

        function updateEventsPage() {
            const tbody = document.getElementById('table-events');
            const events = cachedData.events || [];
            
            if (events.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 10px; color: #FFCC00;">No events found</td></tr>';
                return;
            }

            // Sort by timestamp descending (newest first)
            const sortedEvents = [...events].sort((a, b) => {
                return new Date(b.timestamp) - new Date(a.timestamp);
            });

            tbody.innerHTML = sortedEvents.slice(0, 100).map(e => {
                const severityEmoji = ['‚ö™', 'üü¢', 'üü°', 'üü†', 'üî¥'][e.severity] || '‚ö™';
                return `
                    <tr>
                        <td>${formatDate(e.timestamp)}</td>
                        <td>
                            <span onclick="showEventDetails('${e.event_id}')" style="color: #00CCFF; cursor: pointer; text-decoration: underline; font-weight: bold;">
                                ${e.event_type || 'N/A'}
                            </span>
                        </td>
                        <td>${e.source_host || 'Unknown'}</td>
                        <td>${e.user || 'N/A'}</td>
                        <td>${severityEmoji} ${e.severity || 0}</td>
                        <td style="font-size: 16px; color: #FFCC00; max-width: 400px; overflow: hidden; text-overflow: ellipsis;">${addDrilldownToIPs((e.raw_message || '-').substring(0, 100))}</td>
                    </tr>
                `;
            }).join('');
        }

        function updateHostsPage() {
            const activeHosts = cachedData.hosts?.active || [];
            const inactiveHosts = cachedData.hosts?.inactive || [];

            // Update active hosts table
            const activeTbody = document.getElementById('table-active-hosts');
            if (activeHosts.length === 0) {
                activeTbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 10px; color: #FFCC00;">No active hosts</td></tr>';
            } else {
                activeTbody.innerHTML = activeHosts.map(h => {
                    const hostname = h.hostname || h.source_host || 'Unknown';
                    const osType = h.os_type || 'Unknown';
                    const lastSeen = h.last_seen ? new Date(h.last_seen).toLocaleString() : 'N/A';
                    const totalEvents = h.total_events || 0;
                    return `
                        <tr>
                            <td>
                                <button onclick="showHostDetails('${hostname}')" style="background: none; border: 1px solid #00FF99; color: #00FF99; padding: 4px 8px; cursor: pointer; font-family: 'Orbitron', sans-serif; font-size: 14px; border-radius: 2px;">
                                    üíª ${hostname}
                                </button>
                            </td>
                            <td>${osType}</td>
                            <td>${lastSeen}</td>
                        </tr>
                    `;
                }).join('');
            }

            // Update inactive hosts table
            const inactiveTbody = document.getElementById('table-inactive-hosts');
            if (inactiveHosts.length === 0) {
                inactiveTbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 10px; color: #FFCC00;">No inactive hosts</td></tr>';
            } else {
                inactiveTbody.innerHTML = inactiveHosts.map(h => {
                    const hostname = h.hostname || h.source_host || 'Unknown';
                    const osType = h.os_type || 'Unknown';
                    const lastSeen = h.last_seen ? new Date(h.last_seen).toLocaleString() : 'N/A';
                    return `
                        <tr>
                            <td>
                                <button onclick="showHostDetails('${hostname}')" style="background: none; border: 1px solid #FF3366; color: #FF3366; padding: 4px 8px; cursor: pointer; font-family: 'Orbitron', sans-serif; font-size: 14px; border-radius: 2px;">
                                    üíÄ ${hostname}
                                </button>
                            </td>
                            <td>${osType}</td>
                            <td>${lastSeen}</td>
                        </tr>
                    `;
                }).join('');
            }
            // Re-make tables mobile-friendly after update
            setTimeout(makeTablesMobileFriendly, 100);
        }

        function updateThreatsPage() {
            const tbody = document.getElementById('table-threats');
            const thead = document.querySelector('#page-threats table thead tr');
            
            // Update Headers
            if (thead) {
                thead.innerHTML = `
                    <th>Source IP</th>
                    <th>Events</th>
                    <th>Severity</th>
                    <th>Attack Types</th>
                    <th>Targets</th>
                    <th>Users</th>
                `;
            }

            const events = cachedData.events || [];
            const metrics = cachedData.metrics || {};
            
            // Group events by source IP to get robust details
            const threatMap = {};
            events.forEach(e => {
                const ip = e.source_ip || 'Unknown';
                // Filter out internal/system events from Threat Intelligence
                if (ip === 'N/A' || ip === 'n/a' || ip === 'Unknown' || ip === '127.0.0.1' || ip === '::1' || ip === 'localhost') {
                    return;
                }
                
                if (!threatMap[ip]) {
                    threatMap[ip] = {
                        count: 0, 
                        maxSev: 0, 
                        types: new Set(),
                        hosts: new Set(),
                        users: new Set()
                    };
                }
                threatMap[ip].count++;
                threatMap[ip].maxSev = Math.max(threatMap[ip].maxSev, e.severity || 0);
                if (e.event_type) threatMap[ip].types.add(e.event_type);
                if (e.source_host) threatMap[ip].hosts.add(e.source_host);
                if (e.user && e.user !== 'N/A' && e.user !== 'unknown') threatMap[ip].users.add(e.user);
            });

            const threats = Object.entries(threatMap)
                .map(([ip, data]) => ({
                    ip, 
                    ...data, 
                    typesStr: Array.from(data.types).slice(0, 3).join(', ') + (data.types.size > 3 ? '...' : '')
                }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 50);

            if (threats.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 10px; color: #FFCC00;">No threat data</td></tr>';
                return;
            }

            tbody.innerHTML = threats.map(t => {
                const sevEmoji = ['‚ö™', 'üü¢', 'üü°', 'üü†', 'üî¥'][t.maxSev] || '‚ö™';
                return `
                    <tr>
                        <td>
                            <button onclick="showThreatDetails('${t.ip}')" style="background: none; border: 1px solid #FF9900; color: #FF9900; padding: 4px 8px; cursor: pointer; font-family: 'Orbitron', sans-serif; font-size: 14px; border-radius: 2px;">
                                üîç ${t.ip}
                            </button>
                        </td>
                        <td>${t.count.toLocaleString()}</td>
                        <td>${sevEmoji} ${t.maxSev}</td>
                        <td style="font-size: 14px; color: #AAA;">${t.typesStr || 'N/A'}</td>
                        <td style="font-size: 14px; color: #00FF99;">${t.hosts.size} System(s)</td>
                        <td style="font-size: 14px; color: #00CCFF;">${t.users.size} User(s)</td>
                    </tr>
                `;
            }).join('');
            // Re-make tables mobile-friendly after update
            setTimeout(makeTablesMobileFriendly, 100);
        }

        function updateAlertsPage() {
            const events = cachedData.events || [];
            const alerts = events.filter(e => e.severity >= 4);
            const tbody = document.getElementById('table-alerts');

            if (alerts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 10px; color: #FFCC00;">No critical alerts (Severity 4-5)</td></tr>';
                return;
            }

            // Sort by severity descending, then by timestamp descending
            const sortedAlerts = [...alerts].sort((a, b) => {
                if (b.severity !== a.severity) {
                    return b.severity - a.severity;
                }
                return new Date(b.timestamp) - new Date(a.timestamp);
            });

            tbody.innerHTML = sortedAlerts.slice(0, 100).map(e => {
                const severityEmoji = ['‚ö™', 'üü¢', 'üü°', 'üü†', 'üî¥'][e.severity] || '‚ö™';
                return `
                    <tr>
                        <td>${formatDate(e.timestamp)}</td>
                        <td>
                            <span onclick="showEventDetails('${e.event_id}')" style="color: #00CCFF; cursor: pointer; text-decoration: underline; font-weight: bold;">
                                ${e.event_type || 'N/A'}
                            </span>
                        </td>
                        <td>${e.source_host || 'Unknown'}</td>
                        <td>${e.user || 'N/A'}</td>
                        <td>${severityEmoji} ${e.severity}</td>
                        <td style="font-size: 16px; color: #FFCC00; max-width: 400px; overflow: hidden; text-overflow: ellipsis;">${addDrilldownToIPs((e.raw_message || '-').substring(0, 100))}</td>
                    </tr>
                `;
            }).join('');
            // Re-make tables mobile-friendly after update
            setTimeout(makeTablesMobileFriendly, 100);
        }

        function updateSettingsPage() {
            document.getElementById('settings-api-url').textContent = API_URL;
            document.getElementById('settings-api-key').textContent = API_KEY.substring(0, 8) + '***';
        }

        function updateDashboardTables() {
            const events = cachedData.events || [];
            
            // Top event types
            const typeMap = {};
            events.forEach(e => {
                if (e.event_type) {
                    typeMap[e.event_type] = (typeMap[e.event_type] || 0) + 1;
                }
            });
            const topTypes = Object.entries(typeMap)
                .map(([type, count]) => ({type, count}))
                .sort((a, b) => b.count - a.count)
                .slice(0, 10);

            const totalEvents = events.length || 1;
            const typesTbody = document.getElementById('table-top-types');
            if (topTypes.length === 0) {
                typesTbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 10px; color: #FFCC00;">No data</td></tr>';
            } else {
                typesTbody.innerHTML = topTypes.map(t => `
                    <tr>
                        <td>${t.type}</td>
                        <td>${t.count.toLocaleString()}</td>
                        <td>${Math.round((t.count / totalEvents) * 100)}%</td>
                    </tr>
                `).join('');
            }

            // Top affected hosts
            const hostMap = {};
            events.forEach(e => {
                if (e.source_host) {
                    if (!hostMap[e.source_host]) {
                        hostMap[e.source_host] = {count: 0, maxSev: 0};
                    }
                    hostMap[e.source_host].count++;
                    hostMap[e.source_host].maxSev = Math.max(hostMap[e.source_host].maxSev, e.severity || 0);
                }
            });
            const topHosts = Object.entries(hostMap)
                .map(([host, data]) => ({host, ...data}))
                .sort((a, b) => b.count - a.count)
                .slice(0, 10);

            const hostsTbody = document.getElementById('table-top-hosts');
            if (topHosts.length === 0) {
                hostsTbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 10px; color: #FFCC00;">No data</td></tr>';
            } else {
                hostsTbody.innerHTML = topHosts.map(h => {
                    const sevEmoji = ['‚ö™', 'üü¢', 'üü°', 'üü†', 'üî¥'][h.maxSev] || '‚ö™';
                    return `
                        <tr>
                            <td>
                                <span onclick="showHostDetails('${h.host}')" style="color: #00CCFF; cursor: pointer; text-decoration: underline; font-weight: bold;">
                                    ${h.host}
                                </span>
                            </td>
                            <td>${h.count.toLocaleString()}</td>
                            <td>${sevEmoji} ${h.maxSev}</td>
                        </tr>
                    `;
                }).join('');
            }

            // Recent events (sorted by timestamp, newest first)
            const recentEvents = [...events]
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 20);
            
            const recentTbody = document.getElementById('table-recent-events');
            if (recentEvents.length === 0) {
                recentTbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 10px; color: #FFCC00;">No events</td></tr>';
            } else {
                recentTbody.innerHTML = recentEvents.map(e => {
                    const severityEmoji = ['‚ö™', 'üü¢', 'üü°', 'üü†', 'üî¥'][e.severity] || '‚ö™';
                    return `
                        <tr>
                            <td>${formatDate(e.timestamp)}</td>
                            <td>
                                <span onclick="showEventDetails('${e.event_id}')" style="color: #00CCFF; cursor: pointer; text-decoration: underline; font-weight: bold;">
                                    ${e.event_type || 'N/A'}
                                </span>
                            </td>
                            <td>${e.source_host || 'Unknown'}</td>
                            <td>${e.user || 'N/A'}</td>
                            <td>${severityEmoji} ${e.severity || 0}</td>
                            <td style="font-size: 16px; color: #FFCC00; min-width: 300px;">${addDrilldownToIPs((e.raw_message || '-').substring(0, 200))}</td>
                        </tr>
                    `;
                }).join('');
            }
            // Re-make tables mobile-friendly after update
            setTimeout(makeTablesMobileFriendly, 100);
        }

        // Helper function to fetch with error handling
        async function fetchWithErrorHandling(url, options = {}) {
            try {
                // Check if URL is accessible (not blocked)
                if (!url || url.includes('undefined') || url.includes('null')) {
                    console.error(`Invalid URL: ${url}`);
                    return null;
                }

                const response = await fetch(url, options);
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`HTTP ${response.status} error from ${url}:`, errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                console.log(`‚úì Successfully fetched ${url}`, {
                    success: data.success !== false,
                    dataKeys: Object.keys(data)
                });
                return data;
            } catch (err) {
                // Check for specific error types
                if (err.message.includes('Failed to fetch') || err.name === 'TypeError') {
                    // This could be CORS, network error, or browser extension blocking
                    console.error(`‚úó Network error fetching ${url}:`, {
                        error: err.message,
                        possibleCauses: [
                            'Browser extension blocking request (ad blocker, privacy extension)',
                            'CORS policy blocking request',
                            'API server not running',
                            'Network connectivity issue'
                        ],
                        url: url,
                        apiUrl: API_URL
                    });
                    
                    // Show user-friendly error
                    showConnectionError(url);
                } else {
                    console.error(`‚úó Error fetching ${url}:`, err);
                }
                return null;
            }
        }

        // Show connection error to user
        function showConnectionError(url) {
            // Only show once per session
            if (window.connectionErrorShown) return;
            window.connectionErrorShown = true;
            
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #FF3366;
                color: #FFCC00;
                padding: 15px 20px;
                border: 2px solid #FF9900;
                border-radius: 4px;
                z-index: 10000;
                font-family: 'Orbitron', sans-serif;
                max-width: 400px;
                box-shadow: 0 4px 8px rgba(0,0,0,0.5);
            `;
            errorDiv.innerHTML = `
                <div style="font-weight: 700; margin-bottom: 8px;">‚ö†Ô∏è API CONNECTION ERROR</div>
                <div style="font-size: 12px; margin-bottom: 8px;">
                    Cannot connect to API at: <strong>${API_URL}</strong>
                </div>
                <div style="font-size: 11px; margin-bottom: 10px;">
                    Possible causes:<br>
                    ‚Ä¢ Browser extension blocking requests<br>
                    ‚Ä¢ API server not running<br>
                    ‚Ä¢ CORS configuration issue
                </div>
                <button onclick="this.parentElement.remove(); window.connectionErrorShown = false;" 
                        style="background: #FF9900; color: #000; border: none; padding: 5px 10px; cursor: pointer; font-family: 'Orbitron', sans-serif; font-weight: 600;">
                    DISMISS
                </button>
            `;
            document.body.appendChild(errorDiv);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (errorDiv.parentElement) {
                    errorDiv.remove();
                    window.connectionErrorShown = false;
                }
            }, 10000);
        }

        // Refresh events data
        /**
         * Populate quick filter dropdowns with unique values from events
         */
        function populateQuickFilters() {
            const events = cachedData.events || [];

            // Get unique hosts
            const hosts = [...new Set(events.map(e => e.source_host).filter(Boolean))].sort();
            const hostSelect = document.getElementById('quick-filter-host');
            if (hostSelect) {
                const currentValue = hostSelect.value;
                hostSelect.innerHTML = '<option value="">All Hosts</option>' +
                    hosts.map(h => `<option value="${h}">${h}</option>`).join('');
                hostSelect.value = currentValue;
            }

            // Get unique users
            const users = [...new Set(events.map(e => e.user).filter(Boolean))].sort();
            const userSelect = document.getElementById('quick-filter-user');
            if (userSelect) {
                const currentValue = userSelect.value;
                userSelect.innerHTML = '<option value="">All Users</option>' +
                    users.map(u => `<option value="${u}">${u}</option>`).join('');
                userSelect.value = currentValue;
            }
        }

        async function refreshEventsData() {
            try {
                const result = await fetchWithErrorHandling(
                    `${API_URL}/events?limit=1000`,
                    {headers: {'api-key': API_KEY}}
                );
                if (result) {
                    // Handle both response formats: {events: [...]} or direct array
                    if (result.events && Array.isArray(result.events)) {
                        cachedData.events = result.events;
                    } else if (Array.isArray(result)) {
                        cachedData.events = result;
                    } else {
                        console.warn('Unexpected events response format:', result);
                    }
                    console.log(`Refreshed ${cachedData.events.length} events`);
                    populateQuickFilters();
                }
            } catch (err) {
                console.error('Error refreshing events:', err);
            }
        }

        // Refresh all data (events, hosts, metrics)
        async function refreshAllData() {
            await Promise.all([
                refreshEventsData(),
                refreshHostsData(),
                refreshMetricsData()
            ]);
        }

        // Refresh hosts data
        async function refreshHostsData() {
            try {
                const result = await fetchWithErrorHandling(
                    `${API_URL}/hosts`,
                    {headers: {'api-key': API_KEY}}
                );
                if (result) {
                    cachedData.hosts = {
                        active: result.active_hosts || [],
                        inactive: result.inactive_hosts || []
                    };
                    console.log('Hosts data refreshed:', {
                        active: cachedData.hosts.active.length,
                        inactive: cachedData.hosts.inactive.length,
                        total: cachedData.hosts.active.length + cachedData.hosts.inactive.length
                    });
                } else {
                    console.warn('No hosts data received from API');
                }
            } catch (err) {
                console.error('Error refreshing hosts:', err);
            }
        }

        // Refresh metrics data
        async function refreshMetricsData() {
            try {
                const result = await fetchWithErrorHandling(
                    `${API_URL}/metrics`,
                    {headers: {'api-key': API_KEY}}
                );
                if (result) {
                    cachedData.metrics = result;
                }
            } catch (err) {
                console.error('Error refreshing metrics:', err);
            }
        }

        async function loadData() {
            try {
                console.log('Loading dashboard data from API...');
                
                // Fetch all data in parallel
                const [m, h, e] = await Promise.all([
                    fetchWithErrorHandling(`${API_URL}/metrics`, {headers: {'api-key': API_KEY}}),
                    fetchWithErrorHandling(`${API_URL}/hosts`, {headers: {'api-key': API_KEY}}),
                    fetchWithErrorHandling(`${API_URL}/events?limit=1000`, {headers: {'api-key': API_KEY}})
                ]);

                // Parse responses correctly
                const metrics = m || {};
                const hosts = h ? {
                    active: h.active_hosts || [],
                    inactive: h.inactive_hosts || []
                } : {active: [], inactive: []};
                const events = (e && e.events) ? e.events : (e && Array.isArray(e)) ? e : [];

                // Log what we received for debugging
                console.log('Data loaded:', {
                    metrics: metrics ? {
                        status: 'OK',
                        total_alerts_24h: metrics.total_alerts_24h,
                        threats_by_os: metrics.threats_by_os,
                        top_attacking_ips_count: metrics.top_attacking_ips?.length || 0,
                        events_per_minute_count: metrics.events_per_minute?.length || 0
                    } : 'FAILED',
                    hosts: {
                        active: hosts.active.length,
                        inactive: hosts.inactive.length,
                        total: hosts.active.length + hosts.inactive.length,
                        active_hosts: hosts.active.map(h => h.hostname || h.source_host)
                    },
                    events: events.length
                });

                // Cache data for navigation pages
                cachedData = {events: events, hosts: hosts, metrics: metrics};

                // Use metrics from API when available, fallback to calculated values
                const totalEvents24h = metrics?.total_alerts_24h || cachedData.events.length;
                const criticalEvents = cachedData.events.filter(ev => ev.severity === 5).length;
                const highEvents = cachedData.events.filter(ev => ev.severity === 4).length;
                
                // Calculate blocked events from threats_by_os (sum of all OS threats)
                const blockedEvents = Object.values(metrics?.threats_by_os || {}).reduce((a, b) => a + b, 0);
                
                // Get unique hosts from both hosts endpoint and events
                const hostsFromEndpoint = new Set();
                hosts.active.forEach(h => hostsFromEndpoint.add(h.hostname || h.source_host));
                hosts.inactive.forEach(h => hostsFromEndpoint.add(h.hostname || h.source_host));
                
                // Also get unique hosts from events
                const hostsFromEvents = new Set();
                events.forEach(e => {
                    if (e.source_host) {
                        hostsFromEvents.add(e.source_host);
                    }
                });
                
                // Combine both sets to get total unique systems
                const allUniqueHosts = new Set([...hostsFromEndpoint, ...hostsFromEvents]);
                const totalSystems = allUniqueHosts.size;
                
                // Calculate block rate from 24h data if available
                const blockRate = totalEvents24h > 0 ? ((blockedEvents / totalEvents24h) * 100).toFixed(1) : 0;

                // Update metrics display - use API metrics when available
                document.getElementById('m-total').textContent = totalEvents24h.toLocaleString();
                document.getElementById('m-blocked').textContent = blockedEvents.toLocaleString();
                document.getElementById('m-sources').textContent = allUniqueHosts.size.toLocaleString();
                document.getElementById('m-active').textContent = (hosts.active?.length || 0).toLocaleString();
                document.getElementById('m-inactive').textContent = (hosts.inactive?.length || 0).toLocaleString();

                // Update status indicators - use API data
                document.getElementById('stat-online').textContent = hosts.active?.length || 0;
                document.getElementById('stat-offline').textContent = hosts.inactive?.length || 0;
                document.getElementById('stat-alerts').textContent = (criticalEvents + highEvents);

                // Update charts and tables
                updateMainChart(cachedData.events);
                updateTypesChart(cachedData.events);
                updateSeverityChart(cachedData.events);
                updateDashboardTables();
                
                console.log('Dashboard updated successfully');
            } catch (err) {
                console.error('Error loading data:', err);
                // Show error message in UI
                const errorMsg = `Error loading data: ${err.message || 'Unknown error'}`;
                console.error(errorMsg);
            }
        }

        function updateMainChart(events) {
            const canvas = document.getElementById('mainChart');
            if (!canvas) return;

            // Destroy existing chart
            if (charts.main) {
                try {
                    charts.main.destroy();
                    charts.main = null;
                } catch (e) {
                    console.warn('Error destroying main chart:', e);
                    charts.main = null;
                }
            }

            // Reset canvas
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            const ctx = canvas.getContext('2d');

            // Try to use events_per_minute from metrics API if available
            const metrics = cachedData.metrics || {};
            let hourCounts = new Array(24).fill(0);

            if (metrics.events_per_minute && Array.isArray(metrics.events_per_minute)) {
                // Use API data - convert per-minute to per-hour
                // events_per_minute is array of {minute, os_type, count}
                metrics.events_per_minute.forEach((item) => {
                    try {
                        // Parse the minute timestamp (format: "2025-12-06 05:53")
                        const minuteDate = new Date(item.minute + ':00');
                        const hour = minuteDate.getHours();
                        hourCounts[hour] += (item.count || 0);
                    } catch (err) {
                        console.warn('Error parsing minute data:', item, err);
                    }
                });
            } else {
                // Fallback: Count events per hour from events array
                events.forEach(e => {
                    try {
                        const hour = new Date(e.timestamp).getHours();
                        hourCounts[hour]++;
                    } catch (err) {
                        console.warn('Error parsing timestamp:', e.timestamp);
                    }
                });
            }

            // Generate 24 hour labels (00:00 to 23:00)
            const hours = Array.from({length: 24}, (_, i) => {
                const hour = i < 10 ? '0' + i : i;
                return hour + ':00';
            });

            // Find max for Y-axis scaling
            const maxCount = Math.max(...hourCounts, 1);
            const yMax = Math.ceil(maxCount / 20) * 20; // Round up to nearest 20

            charts.main = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: hours,
                    datasets: [{
                        label: 'Events',
                        data: hourCounts,
                        backgroundColor: '#FF9900',
                        borderColor: '#FFCC00',
                        borderWidth: 0,
                        borderRadius: 0,
                        borderSkipped: false,
                        barThickness: 'flex',
                        categoryPercentage: 0.9,
                        barPercentage: 0.8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#FFCC00',
                                boxWidth: 12,
                                font: {size: 16, family: "'Orbitron', sans-serif"},
                                padding: 10
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: '#333333',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#FFCC00',
                                font: {size: 14, family: "'Orbitron', sans-serif"},
                                maxRotation: 0,
                                autoSkip: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            max: yMax,
                            grid: {
                                color: '#333333',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#FFCC00',
                                font: {size: 14, family: "'Orbitron', sans-serif"},
                                stepSize: Math.max(1, Math.round(yMax / 5))
                            }
                        }
                    }
                }
            });
        }

        function updateTypesChart(events) {
            const canvas = document.getElementById('typesChart');
            if (!canvas) return;

            // Destroy existing chart
            if (charts.types) {
                try {
                    charts.types.destroy();
                    charts.types = null;
                } catch (e) {
                    console.warn('Error destroying types chart:', e);
                    charts.types = null;
                }
            }

            // Reset canvas
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            const ctx = canvas.getContext('2d');

            // Count event types
            const typeCounts = {};
            events.forEach(e => {
                typeCounts[e.event_type] = (typeCounts[e.event_type] || 0) + 1;
            });

            const labels = Object.keys(typeCounts).slice(0, 6);
            const data = labels.map(l => typeCounts[l]);

            charts.types = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels.length ? labels : ['No Data'],
                    datasets: [{
                        data: data.length ? data : [1],
                        backgroundColor: ['#FF9900', '#FF3366', '#FFCC00', '#00FF99', '#0099FF', '#9966FF'],
                        borderColor: '#000000',
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#FFCC00',
                                boxWidth: 12,
                                font: {size: 12, family: "'Orbitron', sans-serif"},
                                padding: 12
                            }
                        }
                    }
                }
            });
        }

        function updateSeverityChart(events) {
            const canvas = document.getElementById('severityChart');
            if (!canvas) return;

            // Destroy existing chart
            if (charts.severity) {
                try {
                    charts.severity.destroy();
                    charts.severity = null;
                } catch (e) {
                    console.warn('Error destroying severity chart:', e);
                    charts.severity = null;
                }
            }

            // Reset canvas
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            const ctx = canvas.getContext('2d');

            // Count by severity
            const severityCounts = {1: 0, 2: 0, 3: 0, 4: 0, 5: 0};
            events.forEach(e => {
                if (severityCounts[e.severity] !== undefined) {
                    severityCounts[e.severity]++;
                }
            });

            charts.severity = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Info', 'Low', 'Medium', 'High', 'Critical'],
                    datasets: [{
                        label: 'Events',
                        data: [severityCounts[1], severityCounts[2], severityCounts[3], severityCounts[4], severityCounts[5]],
                        backgroundColor: ['#00FF99', '#FFCC00', '#FF9900', '#FF3366', '#FF0000'],
                        borderColor: '#000000',
                        borderWidth: 0,
                        borderRadius: 2,
                        barThickness: 'flex',
                        categoryPercentage: 0.8,
                        barPercentage: 0.7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#FFCC00',
                                boxWidth: 12,
                                font: {size: 16, family: "'Orbitron', sans-serif"},
                                padding: 10
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: '#333333',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#FFCC00',
                                font: {size: 12, family: "'Orbitron', sans-serif"}
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#333333',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#FFCC00',
                                font: {size: 12, family: "'Orbitron', sans-serif"}
                            }
                        }
                    }
                }
            });
        }

        // Calculate Stardate (Star Trek TNG style)
        // Reference: Stardate 0 = January 1, 2323
        // Current date (2025) = ~45362 days after reference
        function calculateStardate() {
            const now = new Date();
            const year = now.getFullYear();
            const dayOfYear = Math.floor((now - new Date(year, 0, 0)) / 86400000);
            const stardate = ((year - 2323) * 1000) + (dayOfYear * 2.738);

            // Format stardate as date: Stardate 99999.9 (MM/DD/YY)
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const yearShort = String(year).slice(-2);
            const dateStr = `${month}/${day}/${yearShort}`;

            return `${stardate.toFixed(1)} (${dateStr})`;
        }

        function updateTime() {
            const now = new Date();

            // Update header time if it exists
            const headerTime = document.getElementById('header-time');
            if (headerTime) {
                headerTime.textContent = now.toLocaleTimeString();
            }

            // Update sidebar stardate and current time
            const stardateElement = document.getElementById('stardate');
            const currentTimeElement = document.getElementById('current-time');

            if (stardateElement) {
                stardateElement.textContent = `Stardate ${calculateStardate()}`;
            }

            if (currentTimeElement) {
                // Use local browser time
                const timeOptions = {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                };
                const localTime = now.toLocaleString(undefined, timeOptions);
                currentTimeElement.textContent = `${localTime} LOCAL`;
            }
        }

        // Save scroll position on scroll
        function saveScrollPosition() {
            localStorage.setItem('lastScrollY', window.scrollY);
        }

        // Restore scroll position
        function restoreScrollPosition() {
            const lastScrollY = localStorage.getItem('lastScrollY');
            if (lastScrollY) {
                window.scrollTo(0, parseInt(lastScrollY));
            }
        }

        // Mobile menu toggle
        function setupMobileMenu() {
            const toggleBtn = document.getElementById('mobileMenuToggle');
            const sidebar = document.getElementById('sidebar');
            const backdrop = document.getElementById('sidebarBackdrop');
            
            if (toggleBtn && sidebar) {
                const toggleSidebar = () => {
                    const isOpening = !sidebar.classList.contains('open');
                    sidebar.classList.toggle('open');
                    
                    if (backdrop) {
                        backdrop.classList.toggle('active', sidebar.classList.contains('open'));
                    }
                    
                    // Prevent body scroll when sidebar is open
                    if (window.innerWidth <= 768) {
                        if (sidebar.classList.contains('open')) {
                            document.body.classList.add('sidebar-open');
                        } else {
                            document.body.classList.remove('sidebar-open');
                        }
                    }
                };
                
                toggleBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleSidebar();
                });
                
                if (backdrop) {
                    backdrop.addEventListener('click', () => {
                        sidebar.classList.remove('open');
                        backdrop.classList.remove('active');
                        document.body.classList.remove('sidebar-open');
                    });
                }
                
                // Close sidebar when clicking a nav button on mobile
                const navButtons = document.querySelectorAll('.nav-btn');
                navButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        if (window.innerWidth <= 768) {
                            sidebar.classList.remove('open');
                            if (backdrop) {
                                backdrop.classList.remove('active');
                            }
                            document.body.classList.remove('sidebar-open');
                        }
                    });
                });
                
                // Handle window resize
                window.addEventListener('resize', () => {
                    if (window.innerWidth > 768) {
                        sidebar.classList.remove('open');
                        if (backdrop) {
                            backdrop.classList.remove('active');
                        }
                        document.body.classList.remove('sidebar-open');
                    }
                });
            }
        }

        // Make tables mobile-friendly by adding data labels
        function makeTablesMobileFriendly() {
            const tables = document.querySelectorAll('.data-table');
            tables.forEach(table => {
                const headers = Array.from(table.querySelectorAll('th'));
                const rows = table.querySelectorAll('tbody tr');
                
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    cells.forEach((cell, index) => {
                        if (headers[index]) {
                            cell.setAttribute('data-label', headers[index].textContent.trim());
                        }
                    });
                });
            });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            // Timezone Handling
            const timezoneSelect = document.getElementById('settings-timezone');
            if (timezoneSelect) {
                try {
                    const timezones = Intl.supportedValuesOf('timeZone');
                    timezones.forEach(tz => {
                        const option = document.createElement('option');
                        option.value = tz;
                        option.textContent = tz.replace(/_/g, ' ');
                        timezoneSelect.appendChild(option);
                    });
                    
                    // Load saved preference
                    const savedTz = localStorage.getItem('dashboard_timezone');
                    if (savedTz) timezoneSelect.value = savedTz;
                } catch (e) {
                    console.warn('Timezone API not supported', e);
                }
            }

            setupMobileMenu();
            setupNavigation();

            // Initialize time and stardate display
            updateTime();
            setInterval(updateTime, 1000); // Update every second

            // Setup export buttons
            document.getElementById('btn-export-csv')?.addEventListener('click', exportEventsAsCSV);
            document.getElementById('btn-export-json')?.addEventListener('click', exportEventsAsJSON);

            // Setup host management
            document.getElementById('btn-remove-inactive')?.addEventListener('click', removeInactiveHosts);

            // Setup Telegram settings
            document.getElementById('btn-telegram-test')?.addEventListener('click', testTelegramConnection);
            document.getElementById('btn-telegram-save')?.addEventListener('click', saveTelegramSettings);
            
            // Setup Alert Rules save button
            document.getElementById('btn-save-alerts')?.addEventListener('click', saveAlertConfig);

            // Restore Telegram settings from localStorage
            const savedToken = localStorage.getItem('telegram_bot_token');
            const savedChatId = localStorage.getItem('telegram_chat_id');
            if (savedToken) document.getElementById('telegram-bot-token').value = savedToken;
            if (savedChatId) document.getElementById('telegram-chat-id').value = savedChatId;

            // Restore last page visited
            const lastPage = localStorage.getItem('lastPage');
            if (lastPage && lastPage !== 'dashboard') {
                const button = document.querySelector(`[data-page="${lastPage}"]`);
                if (button) {
                    button.click();
                }
            }

            // Make tables mobile-friendly
            makeTablesMobileFriendly();

            // Re-run after data loads
            setTimeout(makeTablesMobileFriendly, 1000);

            // Restore scroll position after page loads
            setTimeout(restoreScrollPosition, 1500);

            // Save scroll position as user scrolls
            window.addEventListener('scroll', saveScrollPosition);

            // Test API connection first
            const apiConnected = await testAPIConnection();
            if (apiConnected) {
                loadData(); // Load initial dashboard data
                setInterval(() => {
                    loadData();
                    // Re-make tables mobile-friendly after data refresh
                    setTimeout(makeTablesMobileFriendly, 500);
                }, 30000); // Auto-refresh every 30 seconds
            } else {
                console.error('API connection test failed. Data loading disabled.');
                // Show error message
                showConnectionError(API_URL);
            }
        });
    </script>
</body>
</html>
